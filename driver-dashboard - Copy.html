<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard | FikaConnect</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Existing CSS from previous steps */
        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }
        .dashboard-header h2 {
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .dashboard-header p {
            font-size: 1.1em;
            color: #666;
        }

        .dashboard-sections {
            display: grid;
            grid-template-columns: 1fr;
            gap: 40px;
        }

        @media (min-width: 992px) {
            .dashboard-sections {
                grid-template-columns: 1fr 1fr; /* Two columns for larger screens */
            }
        }

        .section-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .section-card h3 {
            font-size: 2em;
            color: var(--primary-color);
            margin-bottom: 25px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
        }

        .section-card .loading-spinner,
        .section-card .no-items-message,
        .section-card .error-message {
            text-align: center;
            padding: 30px;
            font-size: 1.1em;
            color: #777;
        }
        .section-card .loading-spinner {
            color: var(--primary-color);
        }
        .section-card .loading-spinner i {
            margin-right: 10px;
        }
        .section-card .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
        }

        .delivery-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 15px;
            background-color: #fefefe;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            position: relative;
        }
        .delivery-item.available { border-left: 5px solid var(--accent-color); }
        .delivery-item.assigned { border-left: 5px solid var(--primary-color); }

        .delivery-item strong {
            color: #333;
        }
        .delivery-item p {
            margin: 5px 0;
            color: #555;
            line-height: 1.4;
        }
        .delivery-item .booking-id-small {
            font-size: 0.8em;
            color: #888;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .delivery-item .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
            border-top: 1px dashed #eee;
            padding-top: 15px;
        }
        .delivery-item .action-buttons .btn {
            padding: 8px 15px;
            font-size: 0.9em;
        }
        .delivery-item .action-buttons.available-actions {
            justify-content: space-between; /* To separate accept and decline */
        }


        .delivery-item .status-dropdown-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #eee;
            text-align: right;
        }
        .delivery-item .status-dropdown {
            padding: 8px 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 0.95em;
            margin-right: 10px;
        }
        .delivery-item .status-update-btn {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .delivery-item .status-update-btn:hover {
            background-color: var(--dark-text);
        }
        .delivery-item .update-message {
            font-size: 0.9em;
            margin-top: 10px;
            text-align: right;
            color: #28a745; /* Green for success */
        }
        .delivery-item .update-message.error {
            color: #dc3545; /* Red for error */
        }

        /* Status styling from sender-dashboard */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 10px;
        }
        .status-badge.Pending { background-color: #fff3cd; color: #856404; } /* Warning */
        .status-badge.Assigned { background-color: #d1ecf1; color: #0c5460; } /* Info */
        .status-badge.InProgress { background-color: #e2e3e5; color: #383d41; } /* Secondary */
        .status-badge.Completed { background-color: #d4edda; color: #155724; } /* Success */
        .status-badge.Cancelled { background-color: #f8d7da; color: #721c24; } /* Danger */
        .status-badge.PickedUp { background-color: #add8e6; color: #00008b; } /* Light Blue */
        .status-badge.InTransit { background-color: #ffdead; color: #a0522d; } /* Orange-brown */

        /* NEW CSS for Location Tracking Controls */
        .location-tracking-controls {
            background-color: #e9f5ff;
            border: 1px solid #b8daff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,123,255,0.1);
        }
        .location-tracking-controls h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .location-tracking-buttons button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 1em;
        }
        #locationStatus {
            margin-top: 15px;
            font-weight: 600;
            color: #555;
        }
        #locationStatus.tracking-on {
            color: #28a745; /* Green */
        }
        #locationStatus.tracking-off {
            color: #dc3545; /* Red */
        }

        /* NEW CSS for Location map */
        #driverNavigationMap {
            height: 500px; /* Adjust height as needed */
            width: 100%;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        .map-status-message {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: #555;
        }

        /* Add or adjust styles for better map visibility */
        .dashboard-sections {
            grid-template-columns: 1fr; /* Or 1fr 1fr if you have space for two columns next to map */
            gap: 20px; /* Adjust gap to make space for map */
        }
        @media (min-width: 1200px) { /* Adjust breakpoint as needed */
            .dashboard-sections {
                grid-template-columns: 1fr 1fr; /* Example: 2 columns */
            }
            .map-section {
                grid-column: span 2; /* Make map span full width below other sections if needed */
                /* Or if you want it side by side with a list: */
                /* grid-column: 1; */
                /* grid-row: 1 / span 2; */ /* Example: map takes up 2 rows on one side */
            }
        }
        /* New styles for clickable locations */
        .clickable-location {
            cursor: pointer;
            text-decoration: underline;
            color: var(--primary-color);
            font-weight: 600;
        }

        /* NEW CSS for Payment Status Badges */
        .status-badge.Paid {
            background-color: #d4edda; /* Light green */
            color: #155724; /* Dark green */
        }
        .status-badge.PendingPayment {
            background-color: #fff3cd; /* Light yellow */
            color: #856404; /* Dark yellow */
        }
        /* NEW CSS for communication buttons */
        .communication-buttons {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }
        .communication-buttons .btn {
            padding: 5px 10px;
            font-size: 0.85em;
        }
        /* NEW CSS for navigation buttons */
        .navigation-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }
        .navigation-buttons .btn {
            padding: 5px 10px;
            font-size: 0.85em;
        }
    </style>
</head>
<body>

    <header class="page-header">
        <div class="container">
            <h1><a href="landing.html">FikaConnect</a></h1>
            <nav class="main-nav">
                <a href="driver-dashboard.html">Dashboard</a>
                <a href="about.html">About Us</a>
                <a href="#" id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </nav>
        </div>
    </header>

    <main class="container form-container">
        <div class="dashboard-header">
            <h2>Welcome, <span id="userNameDisplay">Driver</span>!</h2>
            <p>Your FikaConnect dashboard for managing deliveries.</p>
        </div>

        <div class="location-tracking-controls">
            <h3><i class="fas fa-location-arrow"></i> Location Tracking & Service Area</h3>
            <div class="location-tracking-buttons">
                <button id="startTrackingBtn" class="primary-btn"><i class="fas fa-play-circle"></i> Start Tracking</button>
                <button id="stopTrackingBtn" class="danger-btn" disabled><i class="fas fa-stop-circle"></i> Stop Tracking</button>
            </div>
            <div style="margin: 15px 0;">
                <label for="serviceRadius" style="font-weight: 600; margin-right: 10px;">Service Radius:</label>
                <select id="serviceRadius" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="5">5 km</option>
                    <option value="10" selected>10 km</option>
                    <option value="15">15 km</option>
                    <option value="20">20 km</option>
                    <option value="50">50 km (All)</option>
                </select>
                <span id="bookingsInRange" style="margin-left: 15px; font-weight: 600; color: var(--primary-color);">0 bookings in range</span>
            </div>
            <p id="locationStatus">Location tracking is currently: <span class="tracking-off">OFF</span></p>
            <div id="locationMessage" class="booking-message" style="display: none;"></div>
        </div>
        <div class="dashboard-sections">
            <div class="section-card">
                <h3><i class="fas fa-box-open"></i> Available Bookings</h3>
                <div id="availableBookingsLoading" class="loading-spinner" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Loading available bookings...
                </div>
                <div id="noAvailableBookingsMessage" class="no-items-message" style="display: none;">
                    <p>No new bookings available at the moment.</p>
                </div>
                <div id="availableBookingsError" class="error-message" style="display: none;"></div>
                <div id="availableBookingsList">
                    </div>
            </div>

            <div class="section-card">
                <h3><i class="fas fa-truck"></i> My Assigned Deliveries</h3>
                <div id="assignedDeliveriesLoading" class="loading-spinner" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Loading your assigned deliveries...
                </div>
                <div id="noAssignedDeliveriesMessage" class="no-items-message" style="display: none;">
                    <p>You currently have no assigned deliveries.</p>
                </div>
                <div id="assignedDeliveriesError" class="error-message" style="display: none;"></div>
                <div id="assignedDeliveriesList">
                    </div>
            </div>
        </div>

        <div class="section-card map-section">
            <h3><i class="fas fa-map-marked-alt"></i> Delivery Map</h3>
            <div id="driverNavigationMap"></div>
            <p id="mapStatusMessage" class="map-status-message"></p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion, collection, query as firestoreQuery, where, orderBy, onSnapshot, GeoPoint, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const logoutBtn = document.getElementById('logoutBtn');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const availableBookingsList = document.getElementById('availableBookingsList');
        const availableBookingsLoading = document.getElementById('availableBookingsLoading');
        const noAvailableBookingsMessage = document.getElementById('noAvailableBookingsMessage');
        const availableBookingsError = document.getElementById('availableBookingsError');
        const assignedDeliveriesList = document.getElementById('assignedDeliveriesList');
        const assignedDeliveriesLoading = document.getElementById('assignedDeliveriesLoading');
        const noAssignedDeliveriesMessage = document.getElementById('noAssignedDeliveriesMessage');
        const assignedDeliveriesError = document.getElementById('assignedDeliveriesError');

        // NEW Location Tracking DOM elements
        const startTrackingBtn = document.getElementById('startTrackingBtn');
        const stopTrackingBtn = document.getElementById('stopTrackingBtn');
        const locationStatusSpan = document.querySelector('#locationStatus span');
        const locationMessageDiv = document.getElementById('locationMessage');
        const serviceRadiusSelect = document.getElementById('serviceRadius');
        const bookingsInRangeSpan = document.getElementById('bookingsInRange');

        // NEW Map DOM elements
        const driverNavigationMapDiv = document.getElementById('driverNavigationMap');
        const mapStatusMessage = document.getElementById('mapStatusMessage');


        // --- Global Variables ---
        let CURRENT_DRIVER_ID = null;
        let CURRENT_DRIVER_LOCATION = null; // Store driver's current location
        let locationWatcherId = null; // To store the ID returned by navigator.geolocation.watchPosition
        let availableBookingsData = []; // Store all available bookings for filtering
        const UPDATE_INTERVAL_MS = 10000; // Update location every 10 seconds

        let map; // Declare a global map variable
        let currentMarker = null; // To keep track of the currently displayed marker

        // --- Map Initialization ---
        function initDriverMap() {
            if (!map && driverNavigationMapDiv) {
                map = L.map('driverNavigationMap').setView([0.347596, 32.582520], 13); // Default to Kampala or a relevant central point
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                console.log("Leaflet map initialized.");
            }
        }

        // --- Show Location on Map Function (Feature 1) ---
        function showLocationOnMap(lat, lng, locationName, bookingId) {
            if (!map) {
                console.warn("Map not initialized. Cannot show location.");
                mapStatusMessage.textContent = "Map not ready. Please wait or refresh.";
                return;
            }

            const location = [lat, lng];
            map.setView(location, 15); // Zoom to the location

            // Remove existing marker if any
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            currentMarker = L.marker(location).addTo(map)
                .bindPopup(`<b>${locationName}</b><br>Booking ID: ${bookingId.substring(0, 8)}`)
                .openPopup();

            driverNavigationMapDiv.scrollIntoView({ behavior: 'smooth' });
            mapStatusMessage.textContent = `Displaying: ${locationName} for Booking ID: ${bookingId.substring(0, 8)}`;
        }


        // --- Event Listeners ---
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                // Optionally stop tracking before logout
                if (locationWatcherId !== null) {
                    stopLocationTracking();
                }
                await signOut(auth);
                window.location.href = 'login.html';
            });
        }

        // NEW Location Tracking Event Listeners
        startTrackingBtn.addEventListener('click', startLocationTracking);
        stopTrackingBtn.addEventListener('click', stopLocationTracking);

        // Service Radius Change Event Listener
        serviceRadiusSelect.addEventListener('change', () => {
            filterAndDisplayAvailableBookings();
        });

        // --- Firebase Location Tracking Functions ---
        function showLocationMessage(message, type) {
            locationMessageDiv.textContent = message;
            locationMessageDiv.className = `booking-message ${type}-message`;
            locationMessageDiv.style.display = 'block';
            setTimeout(() => {
                locationMessageDiv.style.display = 'none';
            }, 5000);
        }

        async function updateDriverLocationInFirestore(position) {
            if (!CURRENT_DRIVER_ID) {
                console.warn("Driver ID not available. Cannot update location.");
                return;
            }

            const { latitude, longitude } = position.coords;
            CURRENT_DRIVER_LOCATION = { lat: latitude, lng: longitude }; // Update global driver location

            try {
                const driverDocRef = doc(db, "users", CURRENT_DRIVER_ID);
                await updateDoc(driverDocRef, {
                    lastKnownLocation: new GeoPoint(latitude, longitude),
                    lastLocationUpdate: serverTimestamp()
                });
                console.log(`Location updated: ${latitude}, ${longitude}`);
                filterAndDisplayAvailableBookings(); // Re-filter bookings based on new location
            } catch (error) {
                console.error("Error updating driver location in Firestore:", error);
                showLocationMessage("Failed to update location in database. Check permissions.", 'error');
            }
        }

        function handleLocationError(error) {
            let message = "Error getting location: ";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += "Permission denied. Please allow location access.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    message += "The request to get user location timed out.";
                    break;
                case error.UNKNOWN_ERROR:
                    message += "An unknown error occurred.";
                    break;
            }
            console.error(message, error);
            showLocationMessage(message, 'error');
            stopTrackingBtn.disabled = true; // Disable stop if tracking failed to start or continue
            startTrackingBtn.disabled = false;
            locationStatusSpan.textContent = "OFF";
            locationStatusSpan.className = 'tracking-off';
        }

        function startLocationTracking() {
            if (!navigator.geolocation) {
                showLocationMessage("Geolocation is not supported by your browser.", 'error');
                return;
            }

            if (locationWatcherId !== null) {
                showLocationMessage("Location tracking is already active.", 'info');
                return;
            }

            showLocationMessage("Starting location tracking...", 'info');
            startTrackingBtn.disabled = true;

            locationWatcherId = navigator.geolocation.watchPosition(
                (position) => {
                    updateDriverLocationInFirestore(position);
                    locationStatusSpan.textContent = "ON";
                    locationStatusSpan.className = 'tracking-on';
                    startTrackingBtn.disabled = true;
                    stopTrackingBtn.disabled = false;
                },
                handleLocationError,
                {
                    enableHighAccuracy: true,
                    maximumAge: 0, // No cached position
                    timeout: 5000 // Get position within 5 seconds
                }
            );

            console.log("Started location tracking. Watcher ID:", locationWatcherId);
            showLocationMessage("Location tracking started. Please ensure location services are enabled.", 'success');
        }

        function stopLocationTracking() {
            if (locationWatcherId !== null) {
                navigator.geolocation.clearWatch(locationWatcherId);
                locationWatcherId = null;
                locationStatusSpan.textContent = "OFF";
                locationStatusSpan.className = 'tracking-off';
                startTrackingBtn.disabled = false;
                stopTrackingBtn.disabled = true;
                showLocationMessage("Location tracking stopped.", 'info');
                console.log("Stopped location tracking.");
            } else {
                showLocationMessage("Tracking is not active.", 'info');
            }
        }

        // --- Distance Calculation (Haversine formula) ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in km
            return distance;
        }

        // --- Fetch and Display Bookings (Real-time listeners) ---
        function fetchAndDisplayBookings() {
            // Real-time listener for Available Bookings
            const availableQ = firestoreQuery( // Using aliased 'firestoreQuery'
                collection(db, "bookings"),
                where("status", "==", "Pending Driver Assignment"),
                orderBy("bookingDate", "asc")
            );

            onSnapshot(availableQ, (snapshot) => {
                // Store all available bookings data for filtering
                availableBookingsData = [];
                snapshot.forEach((doc) => {
                    const bookingData = doc.data();
                    // Exclude bookings already declined by the current driver
                    if (!bookingData.declinedByDrivers || !bookingData.declinedByDrivers.includes(CURRENT_DRIVER_ID)) {
                        availableBookingsData.push({ id: doc.id, data: bookingData });
                    }
                });

                // Filter and display bookings based on distance
                filterAndDisplayAvailableBookings();

                availableBookingsLoading.style.display = 'none';
                availableBookingsError.style.display = 'none';
            }, (error) => {
                console.error("Error fetching available bookings (real-time):", error);
                availableBookingsError.textContent = "Error loading available bookings.";
                availableBookingsError.style.display = 'block';
                availableBookingsLoading.style.display = 'none';
            });

            // Real-time listener for Assigned Deliveries
            const assignedQ = firestoreQuery( // Using aliased 'firestoreQuery'
                collection(db, "bookings"),
                where("assignedDriver", "==", CURRENT_DRIVER_ID),
                where("status", "in", ["Assigned", "Picked Up", "In Transit"]),
                orderBy("bookingDate", "desc")
            );

            onSnapshot(assignedQ, (snapshot) => {
                assignedDeliveriesList.innerHTML = ''; // Clear list for fresh render
                if (snapshot.empty) {
                    noAssignedDeliveriesMessage.style.display = 'block';
                } else {
                    noAssignedDeliveriesMessage.style.display = 'none';
                    snapshot.forEach((doc) => {
                        const booking = doc.data();
                        const bookingId = doc.id;
                        const item = createBookingItem(booking, bookingId, 'assigned');
                        assignedDeliveriesList.appendChild(item);
                    });
                }
                assignedDeliveriesLoading.style.display = 'none';
                assignedDeliveriesError.style.display = 'none';
            }, (error) => {
                console.error("Error fetching assigned deliveries (real-time):", error);
                assignedDeliveriesError.textContent = "Error loading assigned deliveries.";
                assignedDeliveriesError.style.display = 'block';
                assignedDeliveriesLoading.style.display = 'none';
            });
        }

        function filterAndDisplayAvailableBookings() {
            availableBookingsList.innerHTML = ''; // Clear list

            if (availableBookingsData.length === 0) {
                noAvailableBookingsMessage.style.display = 'block';
                bookingsInRangeSpan.textContent = '0 bookings in range';
                return;
            }

            const selectedRadius = parseFloat(serviceRadiusSelect.value);
            let filteredBookings = availableBookingsData;

            // Filter by distance if driver location is available and radius is not "All"
            if (CURRENT_DRIVER_LOCATION && selectedRadius < 50) {
                filteredBookings = availableBookingsData.filter(booking => {
                    const pickupLat = booking.data.pickupLocation?.geopoint?.latitude;
                    const pickupLng = booking.data.pickupLocation?.geopoint?.longitude;
                    if (!pickupLat || !pickupLng) return false;

                    const distance = calculateDistance(
                        CURRENT_DRIVER_LOCATION.lat,
                        CURRENT_DRIVER_LOCATION.lng,
                        pickupLat,
                        pickupLng
                    );
                    return distance <= selectedRadius;
                });
            }

            // Update bookings in range count
            bookingsInRangeSpan.textContent = `${filteredBookings.length} bookings in range`;

            if (filteredBookings.length === 0) {
                noAvailableBookingsMessage.style.display = 'block';
            } else {
                noAvailableBookingsMessage.style.display = 'none';
                filteredBookings.forEach(bookingWrapper => {
                    const booking = bookingWrapper.data;
                    const bookingId = bookingWrapper.id;
                    const item = createBookingItem(booking, bookingId, 'available');
                    availableBookingsList.appendChild(item);
                });
            }
        }


        // --- Create Booking Item HTML (Enhanced with distance info, clickable locations, payment status, and communication buttons) ---
        function createBookingItem(booking, bookingId, type) {
            const item = document.createElement('div');
            item.className = `delivery-item ${type}`;

            // Determine which distance to display
            let distanceHtml = '';
            if (type === 'assigned') {
                if (booking.pickupLocation?.geopoint && booking.dropoffLocation?.geopoint) {
                    const totalDistance = calculateDistance(
                        booking.pickupLocation.geopoint.latitude,
                        booking.pickupLocation.geopoint.longitude,
                        booking.dropoffLocation.geopoint.latitude,
                        booking.dropoffLocation.geopoint.longitude
                    );
                    distanceHtml = `<p>Estimated Total Trip Distance: <strong>${totalDistance.toFixed(2)} km</strong></p>`;
                }
            } else if (CURRENT_DRIVER_LOCATION && booking.pickupLocation?.geopoint) {
                const distanceToPickup = calculateDistance(
                    CURRENT_DRIVER_LOCATION.lat,
                    CURRENT_DRIVER_LOCATION.lng,
                    booking.pickupLocation.geopoint.latitude,
                    booking.pickupLocation.geopoint.longitude
                );
                distanceHtml = `<p>Distance to Pickup: <strong>${distanceToPickup.toFixed(2)} km</strong></p>`;
            }

            // Communication buttons HTML
            const customerPhone = booking.customerPhone || '';
            const recipientContact = booking.recipient?.contact || '';
            let communicationButtonsHtml = '';

            if (customerPhone || recipientContact) {
                communicationButtonsHtml = `
                    <div class="communication-buttons">
                        ${customerPhone ? `<a href="tel:${customerPhone}" class="btn primary-btn"><i class="fas fa-phone"></i> Call Customer</a>` : ''}
                        ${recipientContact ? `<a href="tel:${recipientContact}" class="btn primary-btn"><i class="fas fa-phone"></i> Call Recipient</a>` : ''}
                    </div>
                `;
            }

            // Navigation buttons HTML
            let navigationButtonsHtml = '';
            if (type === 'assigned' && booking.pickupLocation?.geopoint && booking.dropoffLocation?.geopoint) {
                const pickupLat = booking.pickupLocation.geopoint.latitude;
                const pickupLng = booking.pickupLocation.geopoint.longitude;
                const dropoffLat = booking.dropoffLocation.geopoint.latitude;
                const dropoffLng = booking.dropoffLocation.geopoint.longitude;

                const googleMapsPickupUrl = `https://www.google.com/maps/dir/?api=1&destination=${pickupLat},${pickupLng}`;
                const googleMapsDropoffUrl = `https://www.google.com/maps/dir/?api=1&destination=${dropoffLat},${dropoffLng}`;

                // If current location is available, add it as origin for directions
                if (CURRENT_DRIVER_LOCATION) {
                    googleMapsPickupUrl += `&origin=${CURRENT_DRIVER_LOCATION.lat},${CURRENT_DRIVER_LOCATION.lng}`;
                    googleMapsDropoffUrl += `&origin=${CURRENT_DRIVER_LOCATION.lat},${CURRENT_DRIVER_LOCATION.lng}`;
                }

                navigationButtonsHtml = `
                    <div class="navigation-buttons">
                        <a href="${googleMapsPickupUrl}" target="_blank" class="btn primary-btn"><i class="fas fa-map-marker-alt"></i> Navigate to Pickup</a>
                        <a href="${googleMapsDropoffUrl}" target="_blank" class="btn primary-btn"><i class="fas fa-route"></i> Navigate to Dropoff</a>
                    </div>
                `;
            }

            item.innerHTML = `
                <span class="booking-id-small">ID: ${bookingId.substring(0, 8)}</span>
                <p><strong>Package:</strong> ${booking.packageDetails.type}, ${booking.packageDetails.weight} kg</p>
                <p>Pickup: <span class="clickable-location"
                                data-lat="${booking.pickupLocation.geopoint.latitude}"
                                data-lng="${booking.pickupLocation.geopoint.longitude}">${booking.pickupLocation.name}</span></p>
                <p>Dropoff: <span class="clickable-location"
                                  data-lat="${booking.dropoffLocation.geopoint.latitude}"
                                  data-lng="${booking.dropoffLocation.geopoint.longitude}">${booking.dropoffLocation.name}</span></p>
                <p>Customer: ${booking.customerName}</p>
                <p>Contact: ${booking.customerPhone}</p>
                ${booking.recipient?.name ? `<p>Recipient: ${booking.recipient.name} (Contact: ${booking.recipient.contact || 'N/A'})</p>` : ''}
                ${distanceHtml}
                ${booking.specialInstructions ? `<p>Instructions: ${booking.specialInstructions}</p>` : ''}
                ${booking.paymentStatus ? `<p>Payment Status: <span class="status-badge ${booking.paymentStatus.replace(/\s/g, '')}">${booking.paymentStatus}</span></p>` : ''}
                ${communicationButtonsHtml}
                ${navigationButtonsHtml}

                ${type === 'available' ? `
                    <div class="action-buttons available-actions">
                        <button class="btn danger-btn decline-booking-btn" data-id="${bookingId}">
                            <i class="fas fa-times-circle"></i> Decline Booking
                        </button>
                        <button class="btn primary-btn accept-booking-btn" data-id="${bookingId}">
                            <i class="fas fa-check-circle"></i> Accept Booking
                        </button>
                    </div>
                ` : ''}

                ${type === 'assigned' ? `
                    <div class="status-dropdown-container">
                        <select class="status-dropdown" data-id="${bookingId}">
                            <option value="" disabled selected>Update Status</option>
                            <option value="Picked Up" ${booking.status === 'Picked Up' ? 'selected' : ''}>Picked Up</option>
                            <option value="In Transit" ${booking.status === 'In Transit' ? 'selected' : ''}>In Transit</option>
                            <option value="Completed" ${booking.status === 'Completed' ? 'selected' : ''}>Completed</option>
                        </select>
                        <button class="status-update-btn primary-btn" data-id="${bookingId}">Update</button>
                        <div class="update-message" id="updateMessage-${bookingId}" style="display:none;"></div>
                    </div>
                ` : ''}
            `;

            // Add event listeners for clickable locations
            item.querySelectorAll('.clickable-location').forEach(span => {
                span.addEventListener('click', () => {
                    const lat = parseFloat(span.dataset.lat);
                    const lng = parseFloat(span.dataset.lng);
                    const name = span.textContent;
                    showLocationOnMap(lat, lng, name, bookingId);
                });
            });


            if (type === 'available') {
                item.querySelector('.accept-booking-btn').addEventListener('click', () => acceptBooking(bookingId));
                item.querySelector('.decline-booking-btn').addEventListener('click', () => declineBooking(bookingId));
            } else if (type === 'assigned') {
                item.querySelector('.status-update-btn').addEventListener('click', () => updateBookingStatus(bookingId, item));
            }

            return item;
        }

        // --- Accept Booking Function (Existing code, unchanged) ---
        async function acceptBooking(bookingId) {
            const acceptBtn = document.querySelector(`.accept-booking-btn[data-id="${bookingId}"]`);
            if (!acceptBtn) return;

            acceptBtn.disabled = true;
            const originalText = acceptBtn.innerHTML;
            acceptBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accepting...';

            try {
                const bookingRef = doc(db, "bookings", bookingId);
                await updateDoc(bookingRef, {
                    status: "Assigned",
                    assignedDriver: CURRENT_DRIVER_ID,
                    assignmentDate: serverTimestamp(), // Use serverTimestamp() for accurate server time
                });
                // alert(`Booking ${bookingId.substring(0, 8)} accepted successfully!`);
                // Real-time listeners will automatically update, no need to call fetchAndDisplayBookings() directly here
            } catch (error) {
                console.error("Error accepting booking:", error);
                alert("Failed to accept booking. Please try again.");
                acceptBtn.disabled = false;
                acceptBtn.innerHTML = originalText;
            }
        }

        // --- NEW: Decline Booking Function ---
        async function declineBooking(bookingId) {
            const declineBtn = document.querySelector(`.decline-booking-btn[data-id="${bookingId}"]`);
            if (!declineBtn) return;

            declineBtn.disabled = true;
            const originalText = declineBtn.innerHTML;
            declineBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Declining...';

            try {
                const bookingRef = doc(db, "bookings", bookingId);
                // Use arrayUnion to add the current driver's ID to declinedByDrivers array
                await updateDoc(bookingRef, {
                    declinedByDrivers: arrayUnion(CURRENT_DRIVER_ID)
                });
                // The real-time listener will automatically remove this booking from view for this driver
                console.log(`Booking ${bookingId.substring(0, 8)} declined by driver ${CURRENT_DRIVER_ID}.`);
                // Optionally provide a temporary message to the user
                const bookingItem = declineBtn.closest('.delivery-item');
                if (bookingItem) {
                    bookingItem.style.opacity = '0.5'; // Visually indicate it's being removed
                    bookingItem.style.pointerEvents = 'none'; // Disable further interaction
                    setTimeout(() => {
                        // The onSnapshot will actually remove it, this is just immediate feedback
                        // If it doesn't disappear, the onSnapshot might not be configured to filter by declinedByDrivers
                    }, 500);
                }
            } catch (error) {
                console.error("Error declining booking:", error);
                alert("Failed to decline booking. Please try again.");
                declineBtn.disabled = false;
                declineBtn.innerHTML = originalText;
            }
        }

        // --- Update Booking Status Function (Existing code, slightly modified for 'Completed') ---
        async function updateBookingStatus(bookingId, itemElement) {
            const statusDropdown = itemElement.querySelector('.status-dropdown');
            const newStatus = statusDropdown.value;
            const updateMessageDiv = itemElement.querySelector(`#updateMessage-${bookingId}`);

            if (!newStatus) {
                updateMessageDiv.textContent = 'Please select a status.';
                updateMessageDiv.className = 'update-message error';
                updateMessageDiv.style.display = 'block';
                return;
            }

            try {
                const bookingRef = doc(db, "bookings", bookingId);
                const updateData = { status: newStatus };

                if (newStatus === 'Completed') {
                    updateData.completionDate = serverTimestamp();
                }

                await updateDoc(bookingRef, updateData);
                updateMessageDiv.textContent = `Status updated to ${newStatus}!`;
                updateMessageDiv.className = 'update-message success';
                updateMessageDiv.style.display = 'block';
                setTimeout(() => updateMessageDiv.style.display = 'none', 3000);
            } catch (error) {
                console.error("Error updating booking status:", error);
                updateMessageDiv.textContent = `Failed to update status: ${error.message}`;
                updateMessageDiv.className = 'update-message error';
                updateMessageDiv.style.display = 'block';
            }
        }


        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                CURRENT_DRIVER_ID = user.uid;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().isDriver) {
                    userNameDisplay.textContent = userDocSnap.data().name || "Driver";
                    initDriverMap(); // Initialize map here
                    fetchAndDisplayBookings();
                } else {
                    alert("Access Denied: You are not authorized to view this page.");
                    await signOut(auth);
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

    </script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</body>
</html>