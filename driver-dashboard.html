<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard | FikaConnect</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <style>
    /* Enhanced Driver Dashboard Styles */
    :root {
        --primary-color: #047857;
        --primary-dark: #035a42;
        --secondary-color: #6c757d;
        --accent-color: #20c997;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --light-bg: #f8f9fa;
        --dark-text: #212529;
        --border-color: #dee2e6;
        --white: #ffffff;
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
        --header-height: 70px;
        --sidebar-width: 260px;
        --border-radius: 12px;
    }

    body {
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--light-bg);
        color: var(--dark-text);
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    body.dark-mode {
        --light-bg: #121212;
        --dark-text: #f8f9fa;
        --border-color: #343a40;
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        background-color: var(--light-bg);
        color: var(--dark-text);
    }

    /* Modern Top Navigation Bar */
    .top-nav {
        position: sticky;
        top: 0;
        z-index: 1000;
        background-color: var(--white);
        box-shadow: var(--card-shadow);
        height: var(--header-height);
        display: flex;
        align-items: center;
        padding: 0 20px;
        transition: var(--transition);
    }

    body.dark-mode .top-nav {
        background-color: #1e1e1e;
    }

    .nav-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
    }

    .nav-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .logo {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        font-size: 1.6rem;
        color: var(--primary-color);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .logo i {
        color: var(--accent-color);
    }

    .nav-center {
        flex: 1;
        max-width: 400px;
        margin: 0 20px;
    }

    .search-bar {
        position: relative;
        width: 100%;
    }

    .search-bar input {
        width: 100%;
        padding: 10px 15px 10px 40px;
        border-radius: 30px;
        border: 1px solid var(--border-color);
        background-color: rgba(4, 120, 87, 0.05);
        font-family: 'Inter', sans-serif;
        font-size: 0.95rem;
        transition: var(--transition);
    }

    body.dark-mode .search-bar input {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid #343a40;
        color: var(--white);
    }

    .search-bar input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(4, 120, 87, 0.2);
    }

    .search-bar i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
    }

    .nav-right {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .theme-toggle {
        background: transparent;
        border: none;
        font-size: 1.3rem;
        cursor: pointer;
        color: var(--primary-color);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .theme-toggle:hover {
        background: rgba(4, 120, 87, 0.1);
    }

    body.dark-mode .theme-toggle:hover {
        background: rgba(4, 120, 87, 0.2);
    }

    .notification-bell {
        position: relative;
        cursor: pointer;
        color: var(--dark-text);
        font-size: 1.3rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    body.dark-mode .notification-bell {
        color: var(--white);
    }

    .notification-bell:hover {
        background: rgba(4, 120, 87, 0.1);
    }

    body.dark-mode .notification-bell:hover {
        background: rgba(4, 120, 87, 0.2);
    }

    .notification-bell .badge {
        position: absolute;
        top: -3px;
        right: -3px;
        background-color: var(--danger-color);
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 0.6em;
        font-weight: bold;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .nav-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 5px;
        border-radius: 30px;
        transition: var(--transition);
    }

    .nav-profile:hover {
        background: rgba(4, 120, 87, 0.1);
    }

    body.dark-mode .nav-profile:hover {
        background: rgba(4, 120, 87, 0.2);
    }

    .profile-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary-color);
    }

    .profile-info {
        display: flex;
        flex-direction: column;
        text-align: right;
    }

    .profile-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--dark-text);
    }

    body.dark-mode .profile-name {
        color: var(--white);
    }

    .profile-role {
        font-size: 0.8rem;
        color: var(--secondary-color);
    }

    body.dark-mode .profile-role {
        color: #adb5bd;
    }

    .dropdown-arrow {
        color: var(--secondary-color);
        transition: var(--transition);
    }

    .nav-profile.active .dropdown-arrow {
        transform: rotate(180deg);
    }

    /* Mobile Menu Toggle */
    .menu-toggle {
        display: none;
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--primary-color);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .menu-toggle:hover {
        background: rgba(4, 120, 87, 0.1);
    }

    body.dark-mode .menu-toggle:hover {
        background: rgba(4, 120, 87, 0.2);
    }

    /* Mobile Menu */
    .mobile-menu {
        position: fixed;
        top: var(--header-height);
        left: 0;
        width: 100%;
        background-color: var(--white);
        box-shadow: 0 10px 10px rgba(0, 0, 0, 0.1);
        z-index: 999;
        padding: 20px;
        transform: translateY(-100%);
        transition: transform 0.3s ease;
        border-bottom: 1px solid var(--border-color);
    }

    body.dark-mode .mobile-menu {
        background-color: #1e1e1e;
        border-bottom: 1px solid #343a40;
    }

    .mobile-menu.active {
        transform: translateY(0);
    }

    .mobile-nav-links {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
    }

    .mobile-nav-links a {
        text-decoration: none;
        color: var(--dark-text);
        padding: 12px 15px;
        font-weight: 600;
        transition: var(--transition);
        border-radius: 8px;
        font-size: 1em;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    body.dark-mode .mobile-nav-links a {
        color: var(--white);
    }

    .mobile-nav-links a:hover {
        color: var(--white);
        background-color: var(--primary-color);
    }

    .mobile-nav-actions {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .mobile-theme-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }

    .mobile-theme-toggle:hover {
        background: rgba(4, 120, 87, 0.1);
    }

    body.dark-mode .mobile-theme-toggle:hover {
        background: rgba(4, 120, 87, 0.2);
    }

    .mobile-logout-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        background-color: var(--danger-color);
        color: var(--white);
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: var(--transition);
        border: none;
        cursor: pointer;
        font-size: 1em;
        justify-content: center;
    }

    .mobile-logout-btn:hover {
        background-color: #c82333;
    }

    /* Main Content */
    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px 20px;
        flex-grow: 1;
    }

    /* Responsive Improvements */
    @media (max-width: 991px) {
        .nav-center {
            max-width: 300px;
        }
    }

    @media (max-width: 768px) {
        .menu-toggle {
            display: flex;
        }

        .nav-center {
            display: none;
        }

        .nav-right .theme-toggle,
        .nav-right .notification-bell,
        .nav-right .nav-profile {
            display: none;
        }

        .mobile-menu-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .mobile-profile-section {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        body.dark-mode .mobile-profile-section {
            border-bottom: 1px solid #343a40;
        }

        .mobile-profile-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }

        .mobile-profile-info {
            display: flex;
            flex-direction: column;
        }

        .mobile-profile-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .mobile-profile-role {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        body.dark-mode .mobile-profile-role {
            color: #adb5bd;
        }

        .mobile-notifications {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification-item {
            padding: 12px 15px;
            border-radius: 8px;
            background: rgba(4, 120, 87, 0.05);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body.dark-mode .notification-item {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item i {
            color: var(--primary-color);
        }

        .dashboard-header {
            margin-bottom: 20px;
        }

        .dashboard-sections {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .section-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 20px;
            transition: var(--transition);
        }

        body.dark-mode .section-card {
            background-color: #1e1e1e;
        }

        .section-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.25rem;
            color: var(--primary-color);
        }

        .location-tracking-controls {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        body.dark-mode .location-tracking-controls {
            background-color: #1e1e1e;
        }

        .location-tracking-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .primary-btn, .danger-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: var(--transition);
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--white);
        }

        .primary-btn {
            background-color: var(--primary-color);
        }

        .primary-btn:hover {
            background-color: var(--primary-dark);
        }

        .danger-btn {
            background-color: var(--danger-color);
        }

        .danger-btn:hover {
            background-color: #c82333;
        }

        .primary-btn:disabled, .danger-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .booking-message, .update-message {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        .info-message {
            background-color: #e2f3ff;
            color: #0c5460;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        body.dark-mode .info-message {
            background-color: #0c5460;
            color: #e2f3ff;
        }
        body.dark-mode .success-message {
            background-color: #155724;
            color: #d4edda;
        }
        body.dark-mode .error-message {
            background-color: #721c24;
            color: #f8d7da;
        }

        .delivery-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--light-bg);
            transition: var(--transition);
        }

        body.dark-mode .delivery-item {
            background-color: #2a2a2a;
            border-color: #444;
        }

        .delivery-item p {
            margin: 5px 0;
            font-size: 0.95rem;
        }

        .delivery-item strong {
            color: var(--dark-text);
        }
        
        body.dark-mode .delivery-item strong {
            color: var(--white);
        }

        .delivery-item.available {
            border-left: 5px solid var(--accent-color);
        }

        .delivery-item.assigned {
            border-left: 5px solid var(--info-color);
        }
        
        .booking-id-small {
            font-size: 0.75rem;
            color: var(--secondary-color);
            float: right;
            font-weight: 600;
        }

        .clickable-location {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
        }

        .action-buttons, .communication-buttons, .navigation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status-dropdown-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }

        .status-dropdown {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--white);
            color: var(--dark-text);
            font-family: 'Inter', sans-serif;
        }

        body.dark-mode .status-dropdown {
            background-color: #343a40;
            color: var(--white);
            border-color: #444;
        }
        
        .loading-spinner, .no-items-message {
            text-align: center;
            padding: 20px;
            color: var(--secondary-color);
        }

        .loading-spinner i {
            margin-right: 10px;
        }
        
        .tracking-on {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .tracking-off {
            color: var(--danger-color);
            font-weight: 600;
        }
        
        .map-section {
            height: 500px;
            padding: 20px;
        }

        #driverNavigationMap {
            height: calc(100% - 70px);
            border-radius: 8px;
            z-index: 1; /* Ensure map is visible */
        }
    }
      /* New Styles for Reorganized Layout */
        .dashboard-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .section-card h3 {
            margin-bottom: 25px;
            position: relative;
            padding-bottom: 10px;
        }

        .section-card h3::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 50px;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 2px;
        }

        /* --- New Available Booking Card Style --- */
        .booking-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        body.dark-mode .booking-card {
            background-color: #1e1e1e;
        }

        .booking-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .booking-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .booking-card-header h4 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .booking-card-header h4 {
            color: var(--accent-color);
        }

        .booking-card-header .fare {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .booking-card-info {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .booking-card-info p {
            margin: 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .booking-card-info p i {
            color: var(--primary-color);
            font-size: 1.1em;
        }

        .booking-card-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        /* --- New Assigned Delivery List Style --- */
        .assigned-delivery-item {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 15px;
            margin-bottom: 15px;
            transition: var(--transition);
        }

        body.dark-mode .assigned-delivery-item {
            background-color: #1e1e1e;
        }

        .assigned-delivery-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        body.dark-mode .assigned-delivery-item-header {
            border-bottom: 1px solid #343a40;
        }

        .assigned-delivery-item-header h5 {
            margin: 0;
            font-size: 1rem;
            color: var(--primary-dark);
        }

        body.dark-mode .assigned-delivery-item-header h5 {
            color: var(--accent-color);
        }

        .assigned-delivery-item-header .status-tag {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            color: var(--white);
        }

        .status-tag.DriverAssigned { background-color: var(--info-color); }
        .status-tag.PickedUp { background-color: var(--primary-color); }
        .status-tag.InTransit { background-color: var(--warning-color); color: var(--dark-text); }

        .assigned-delivery-item-body p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .assigned-delivery-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .status-update-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .status-update-btn:hover {
            background-color: var(--primary-dark);
        }
        /* New Styles for Driver Performance Section */
.metric-box {
    background-color: var(--light-bg);
    border-radius: 8px;
    padding: 15px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    flex: 1;
    transition: var(--transition);
}

body.dark-mode .metric-box {
    background-color: #2a2a2a;
}

.metric-box h4 {
    margin: 0 0 5px 0;
    font-size: 0.9rem;
    color: var(--secondary-color);
}

.metric-box p {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
}

body.dark-mode .metric-box p {
    color: var(--accent-color);
}

/* New Styles for the Vehicle Management Card */
    .vehicle-details-card {
        padding: 20px;
        background-color: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
    }
    body.dark-mode .vehicle-details-card {
        background-color: #1e1e1e;
    }
    .vehicle-form-group {
        margin-bottom: 15px;
    }
    .vehicle-form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
    }
    .vehicle-form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--light-bg);
        color: var(--dark-text);
        transition: var(--transition);
    }
    body.dark-mode .vehicle-form-group input {
        background-color: #333;
        border-color: #444;
        color: white;
    }
    .vehicle-form-group input:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 2px rgba(22, 160, 133, 0.2);
    }
    .save-vehicle-btn {
        width: 100%;
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: var(--transition);
    }
    .save-vehicle-btn:hover {
        background-color: var(--primary-dark);
    }
    </style>
</head>
<body>
    <header class="top-nav">
        <div class="nav-container">
            <div class="nav-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="#" class="logo">
                    <i class="fas fa-truck-moving"></i>
                    FikaConnect
                </a>
            </div>

            <div class="nav-center">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search bookings, deliveries...">
                </div>
            </div>

            <div class="nav-right">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>

                <div class="notification-bell" id="notificationBell">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notificationCount"></span>
                </div>

                <div class="nav-profile" id="navProfile">
                    <div class="profile-info">
                        <span class="profile-name" id="userNameDisplay">J. Doe</span>
                        <span class="profile-role">Driver</span>
                    </div>
                    <img src="https://via.placeholder.com/40" alt="Profile" class="profile-img">
                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                </div>
            </div>
        </div>
    </header>

    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-content">
            <div class="mobile-profile-section">
                <img src="https://via.placeholder.com/50" alt="Profile" class="mobile-profile-img">
                <div class="mobile-profile-info">
                    <span class="mobile-profile-name">J. Doe</span>
                    <span class="mobile-profile-role">Driver</span>
                </div>
            </div>

            <div class="mobile-nav-links">
                <a href="#"><i class="fas fa-home"></i> Dashboard</a>
                <a href="#"><i class="fas fa-box"></i> Deliveries</a>
                <a href="#"><i class="fas fa-history"></i> History</a>
                <a href="#"><i class="fas fa-truck-moving"></i> Vehicles</a>
                <a href="#"><i class="fas fa-cog"></i> Settings</a>
                <a href="#"><i class="fas fa-headset"></i> Support</a>
            </div>

            <div class="mobile-notifications">
                <div class="notification-item">
                    <i class="fas fa-bell"></i>
                    <span>New booking assigned - ID: FC2345</span>
                </div>
                <div class="notification-item">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Reminder: Vehicle maintenance due</span>
                </div>
                <div class="notification-item">
                    <i class="fas fa-star"></i>
                    <span>Customer rated your service - 5 stars</span>
                </div>
            </div>

            <div class="mobile-nav-actions">
                <div class="mobile-theme-toggle" id="mobileThemeToggle">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </div>
                <a href="#" class="mobile-logout-btn" id="mobileLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </div>

    <main class="container">
        <div class="dashboard-header">
            <h1>Driver Dashboard</h1>
            <p>Welcome back, J. Doe. Here's what's happening with your deliveries today.</p>
        </div>

        <div class="location-tracking-controls">
            <h3><i class="fas fa-location-arrow"></i> Location Tracking & Service Area</h3>
            <div class="location-tracking-buttons">
                <button id="startTrackingBtn" class="primary-btn"><i class="fas fa-play-circle"></i> Start Tracking</button>
                <button id="stopTrackingBtn" class="danger-btn" disabled><i class="fas fa-stop-circle"></i> Stop Tracking</button>
            </div>
            <div style="margin: 15px 0;">
                <label for="serviceRadius" style="font-weight: 600; margin-right: 10px;">Service Radius:</label>
                <select id="serviceRadius" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="5">5 km</option>
                    <option value="10" selected>10 km</option>
                    <option value="15">15 km</option>
                    <option value="20">20 km</option>
                    <option value="50">50 km (All)</option>
                </select>
                <span id="bookingsInRange" style="margin-left: 15px; font-weight: 600; color: var(--primary-color);">0 bookings in range</span>
            </div>
            <p id="locationStatus">Location tracking is currently: <span class="tracking-off">OFF</span></p>
            <div id="locationMessage" class="booking-message" style="display: none;"></div>
        </div>
       <main class="container">
    <div class="dashboard-sections">
        <div class="section-card" id="driverPerformanceCard">
            <h3><i class="fas fa-chart-line"></i> Driver Performance</h3>
            <div id="performanceMetrics" style="display: flex; justify-content: space-around; gap: 20px; text-align: center;">
                <div class="metric-box">
                    <h4>Total Deliveries</h4>
                    <p id="totalDeliveries">0</p>
                </div>
                <div class="metric-box">
                    <h4>Total Earnings</h4>
                    <p id="totalEarnings">UGX 0</p>
                </div>
                <div class="metric-box">
                    <h4>Average Rating</h4>
                    <p id="averageRating">N/A</p>
                </div>
            </div>
            <div id="performanceLoading" class="loading-spinner" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Loading performance data...
            </div>
        </div>

        <div class="section-card">
            <h3><i class="fas fa-box-open"></i> Available Bookings</h3>
            </div>

       <div class="section-card">
    <h3><i class="fas fa-truck"></i> My Assigned Deliveries</h3>
    <div class="assigned-deliveries-header">
        <button id="showRouteBtn" class="btn primary-btn"><i class="fas fa-route"></i> Show Optimized Route</button>
    </div>
    <div id="assignedDeliveriesLoading" class="loading-spinner" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> Loading your assigned deliveries...
    </div>
    <div id="noAssignedDeliveriesMessage" class="no-items-message" style="display: none;">
        <p>You currently have no assigned deliveries.</p>
    </div>
    <div id="assignedDeliveriesError" class="error-message" style="display: none;"></div>
    <div id="assignedDeliveriesList">
    </div>
</div>
<main class="container">
        <div class="dashboard-sections">
            <div class="section-card" id="driverPerformanceCard">
                </div>
            
            <div class="section-card vehicle-details-card">
                <h3><i class="fas fa-car"></i> Vehicle Management</h3>
                <form id="vehicleDetailsForm">
                    <div class="vehicle-form-group">
                        <label for="vehicleMake">Make:</label>
                        <input type="text" id="vehicleMake" name="vehicleMake" placeholder="e.g., Toyota">
                    </div>
                    <div class="vehicle-form-group">
                        <label for="vehicleModel">Model:</label>
                        <input type="text" id="vehicleModel" name="vehicleModel" placeholder="e.g., Vitz">
                    </div>
                    <div class="vehicle-form-group">
                        <label for="licensePlate">License Plate:</label>
                        <input type="text" id="licensePlate" name="licensePlate" placeholder="e.g., UAX 123">
                    </div>
                    <div class="vehicle-form-group">
                        <label for="insuranceExpiration">Insurance Expiration:</label>
                        <input type="date" id="insuranceExpiration" name="insuranceExpiration">
                    </div>
                    <button type="submit" id="saveVehicleBtn" class="save-vehicle-btn"><i class="fas fa-save"></i> Save Vehicle Details</button>
                </form>
                <div id="vehicleMessage" class="booking-message" style="display: none;"></div>
            </div>

            <div class="section-card">
                </div>

            <div class="section-card">
                </div>
        </div>
    </main>

    
  <script type="module">
    // Import necessary Firebase and Leaflet libraries
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayUnion, collection, query, where, orderBy, onSnapshot, GeoPoint, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Your Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDq3uO76nnqqPgPaFfXpOTEnFSXRqXneWU",
        authDomain: "fika-connect-5f844.firebaseapp.com",
        projectId: "fika-connect-5f844",
        storageBucket: "fika-connect-5f844.appspot.com",
        messagingSenderId: "492360448361",
        appId: "1:492360448361:web:4ab28b2b9828371d4b2f4a"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM Elements ---
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    const userNameDisplay = document.getElementById('userNameDisplay');
    const mobileUserNameDisplay = document.querySelector('.mobile-profile-name');
    const availableBookingsList = document.getElementById('availableBookingsList');
    const availableBookingsLoading = document.getElementById('availableBookingsLoading');
    const noAvailableBookingsMessage = document.getElementById('noAvailableBookingsMessage');
    const availableBookingsError = document.getElementById('availableBookingsError');
    const assignedDeliveriesList = document.getElementById('assignedDeliveriesList');
    const assignedDeliveriesLoading = document.getElementById('assignedDeliveriesLoading');
    const noAssignedDeliveriesMessage = document.getElementById('noAssignedDeliveriesMessage');
    const assignedDeliveriesError = document.getElementById('assignedDeliveriesError');
    const showRouteBtn = document.getElementById('showRouteBtn');
    // New DOM elements for Performance
    const totalDeliveriesEl = document.getElementById('totalDeliveries');
    const totalEarningsEl = document.getElementById('totalEarnings');
    const averageRatingEl = document.getElementById('averageRating');
    const performanceLoadingEl = document.getElementById('performanceLoading');
    // New DOM elements for Vehicle Management
    const vehicleDetailsForm = document.getElementById('vehicleDetailsForm');
    const vehicleMakeInput = document.getElementById('vehicleMake');
    const vehicleModelInput = document.getElementById('vehicleModel');
    const licensePlateInput = document.getElementById('licensePlate');
    const insuranceExpirationInput = document.getElementById('insuranceExpiration');
    const saveVehicleBtn = document.getElementById('saveVehicleBtn');
    const vehicleMessageDiv = document.getElementById('vehicleMessage');


    const menuToggle = document.getElementById('menuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    const themeToggle = document.getElementById('themeToggle');
    const mobileThemeToggle = document.getElementById('mobileThemeToggle');
    const navProfile = document.getElementById('navProfile');
    const body = document.body;

    // Location Tracking DOM elements
    const startTrackingBtn = document.getElementById('startTrackingBtn');
    const stopTrackingBtn = document.getElementById('stopTrackingBtn');
    const locationStatusSpan = document.querySelector('#locationStatus span');
    const locationMessageDiv = document.getElementById('locationMessage');
    const serviceRadiusSelect = document.getElementById('serviceRadius');
    const bookingsInRangeSpan = document.getElementById('bookingsInRange');

    // Map DOM elements
    const driverNavigationMapDiv = document.getElementById('driverNavigationMap');
    const mapStatusMessage = document.getElementById('mapStatusMessage');

    // --- Global Variables ---
    let CURRENT_DRIVER_ID = null;
    let CURRENT_DRIVER_LOCATION = null;
    let locationWatcherId = null;
    let availableBookingsData = [];
    let assignedDeliveriesData = []; // Store assigned deliveries globally
    let map;
    let currentMarker = null;
    let routingControl = null; // New variable to hold the routing control

    // --- UI & Event Handlers ---
    document.addEventListener('DOMContentLoaded', () => {
        // Apply saved theme preference
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            body.classList.add('dark-mode');
            updateThemeIcons();
        }

        // Mobile menu toggle
        if (menuToggle && mobileMenu) {
            menuToggle.addEventListener('click', () => {
                mobileMenu.classList.toggle('active');
            });
        }

        // Theme toggle buttons
        if (themeToggle) {
            themeToggle.addEventListener('click', toggleTheme);
        }
        if (mobileThemeToggle) {
            mobileThemeToggle.addEventListener('click', toggleTheme);
        }

        // Profile dropdown toggle
        if (navProfile) {
            navProfile.addEventListener('click', () => {
                navProfile.classList.toggle('active');
            });
        }

        // Close menus when clicking outside
        document.addEventListener('click', (event) => {
            // Close mobile menu
            if (mobileMenu && mobileMenu.classList.contains('active') && !menuToggle.contains(event.target) && !mobileMenu.contains(event.target)) {
                mobileMenu.classList.remove('active');
            }
            
            // Close profile dropdown
            if (navProfile && navProfile.classList.contains('active') && !navProfile.contains(event.target)) {
                navProfile.classList.remove('active');
            }
        });

        // Logout button for mobile menu
        if (mobileLogoutBtn) {
            mobileLogoutBtn.addEventListener('click', async () => {
                if (locationWatcherId !== null) {
                    stopLocationTracking();
                }
                await signOut(auth);
                window.location.href = 'login.html';
            });
        }

        // New: Show Route Button Handler
        if (showRouteBtn) {
            showRouteBtn.addEventListener('click', showOptimizedRoute);
        }

        // New: Vehicle Details Form Handler
        if (vehicleDetailsForm) {
            vehicleDetailsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveVehicleDetails();
            });
        }
    });

    function toggleTheme() {
        body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeIcons();
    }

    function updateThemeIcons() {
        const isDark = body.classList.contains('dark-mode');
        const icons = document.querySelectorAll('.theme-toggle i, .mobile-theme-toggle i');
        icons.forEach(icon => {
            if (isDark) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        });
    }

    // --- Map Initialization ---
    function initDriverMap() {
        if (!map && driverNavigationMapDiv) {
            map = L.map('driverNavigationMap').setView([0.347596, 32.582520], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            console.log("Leaflet map initialized.");
        }
    }

    // --- Show Location on Map Function ---
    function showLocationOnMap(lat, lng, locationName, bookingId) {
        if (!map) {
            console.warn("Map not initialized. Cannot show location.");
            mapStatusMessage.textContent = "Map not ready. Please wait or refresh.";
            return;
        }

        // Clear existing routing line if it exists
        if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
        }
        
        // Remove existing marker if it's not a routing marker
        if (currentMarker) {
            map.removeLayer(currentMarker);
        }
        
        const location = [lat, lng];
        map.setView(location, 15);

        currentMarker = L.marker(location).addTo(map)
            .bindPopup(`<b>${locationName}</b><br>Booking ID: ${bookingId.substring(0, 8)}`)
            .openPopup();

        driverNavigationMapDiv.scrollIntoView({ behavior: 'smooth' });
        mapStatusMessage.textContent = `Displaying: ${locationName} for Booking ID: ${bookingId.substring(0, 8)}`;
    }

    // --- Location Tracking Functions ---
    function showLocationMessage(message, type) {
        if (!locationMessageDiv) return;
        locationMessageDiv.textContent = message;
        locationMessageDiv.className = `booking-message ${type}-message`;
        locationMessageDiv.style.display = 'block';
        setTimeout(() => {
            locationMessageDiv.style.display = 'none';
        }, 5000);
    }
    
    function showVehicleMessage(message, type) {
        if (!vehicleMessageDiv) return;
        vehicleMessageDiv.textContent = message;
        vehicleMessageDiv.className = `booking-message ${type}-message`;
        vehicleMessageDiv.style.display = 'block';
        setTimeout(() => {
            vehicleMessageDiv.style.display = 'none';
        }, 5000);
    }

    async function updateDriverLocationInFirestore(position) {
        if (!CURRENT_DRIVER_ID) {
            console.warn("Driver ID not available. Cannot update location.");
            return;
        }

        const { latitude, longitude } = position.coords;
        CURRENT_DRIVER_LOCATION = { lat: latitude, lng: longitude };

        try {
            const driverDocRef = doc(db, "users", CURRENT_DRIVER_ID);
            await updateDoc(driverDocRef, {
                lastKnownLocation: new GeoPoint(latitude, longitude),
                lastLocationUpdate: serverTimestamp()
            });
            console.log(`Location updated: ${latitude}, ${longitude}`);
            filterAndDisplayAvailableBookings();
        } catch (error) {
            console.error("Error updating driver location in Firestore:", error);
            showLocationMessage("Failed to update location in database. Check permissions.", 'error');
        }
    }

    function handleLocationError(error) {
        let message = "Error getting location: ";
        switch (error.code) {
            case error.PERMISSION_DENIED:
                message += "Permission denied. Please allow location access.";
                break;
            case error.POSITION_UNAVAILABLE:
                message += "Location information is unavailable.";
                break;
            case error.TIMEOUT:
                message += "The request to get user location timed out.";
                break;
            case error.UNKNOWN_ERROR:
                message += "An unknown error occurred.";
                break;
        }
        console.error(message, error);
        showLocationMessage(message, 'error');
        if (stopTrackingBtn) stopTrackingBtn.disabled = true;
        if (startTrackingBtn) startTrackingBtn.disabled = false;
        if (locationStatusSpan) {
            locationStatusSpan.textContent = "OFF";
            locationStatusSpan.className = 'tracking-off';
        }
    }

    function startLocationTracking() {
        if (!navigator.geolocation) {
            showLocationMessage("Geolocation is not supported by your browser.", 'error');
            return;
        }

        if (locationWatcherId !== null) {
            showLocationMessage("Location tracking is already active.", 'info');
            return;
        }

        showLocationMessage("Starting location tracking...", 'info');
        if (startTrackingBtn) startTrackingBtn.disabled = true;

        locationWatcherId = navigator.geolocation.watchPosition(
            (position) => {
                updateDriverLocationInFirestore(position);
                if (locationStatusSpan) {
                    locationStatusSpan.textContent = "ON";
                    locationStatusSpan.className = 'tracking-on';
                }
                if (startTrackingBtn) startTrackingBtn.disabled = true;
                if (stopTrackingBtn) stopTrackingBtn.disabled = false;
            },
            handleLocationError,
            {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            }
        );

        console.log("Started location tracking. Watcher ID:", locationWatcherId);
        showLocationMessage("Location tracking started. Please ensure location services are enabled.", 'success');
    }

    function stopLocationTracking() {
        if (locationWatcherId !== null) {
            navigator.geolocation.clearWatch(locationWatcherId);
            locationWatcherId = null;
            if (locationStatusSpan) {
                locationStatusSpan.textContent = "OFF";
                locationStatusSpan.className = 'tracking-off';
            }
            if (startTrackingBtn) startTrackingBtn.disabled = false;
            if (stopTrackingBtn) stopTrackingBtn.disabled = true;
            showLocationMessage("Location tracking stopped.", 'info');
            console.log("Stopped location tracking.");
        } else {
            showLocationMessage("Tracking is not active.", 'info');
        }
    }

    // --- Distance Calculation ---
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c;
        return distance;
    }

    // --- Fetch and Display Bookings ---
    function fetchAndDisplayBookings() {
        if (availableBookingsLoading) availableBookingsLoading.style.display = 'block';
        if (assignedDeliveriesLoading) assignedDeliveriesLoading.style.display = 'block';

        // Real-time listener for Available Bookings
        const availableQ = query(
            collection(db, "bookings"),
            where("status", "==", "Pending Driver Assignment"),
            orderBy("bookingDate", "asc")
        );

        onSnapshot(availableQ, (snapshot) => {
            availableBookingsData = [];
            snapshot.forEach((doc) => {
                const bookingData = doc.data();
                if (!bookingData.declinedByDrivers || !bookingData.declinedByDrivers.includes(CURRENT_DRIVER_ID)) {
                    availableBookingsData.push({ id: doc.id, data: bookingData });
                }
            });

            filterAndDisplayAvailableBookings();

            if (availableBookingsLoading) availableBookingsLoading.style.display = 'none';
            if (availableBookingsError) availableBookingsError.style.display = 'none';
        }, (error) => {
            console.error("Error fetching available bookings (real-time):", error);
            if (availableBookingsError) {
                availableBookingsError.textContent = "Error loading available bookings: " + error.message;
                availableBookingsError.style.display = 'block';
            }
            if (availableBookingsLoading) availableBookingsLoading.style.display = 'none';
        });

        // Real-time listener for Assigned Deliveries
        const assignedQ = query(
            collection(db, "bookings"),
            where("assignedDriver", "==", CURRENT_DRIVER_ID),
            where("status", "in", ["Driver Assigned", "In Transit", "Picked Up"]),
            orderBy("bookingDate", "desc")
        );

        onSnapshot(assignedQ, (snapshot) => {
            if (assignedDeliveriesList) assignedDeliveriesList.innerHTML = '';
            assignedDeliveriesData = []; // Clear previous data
            if (snapshot.empty) {
                if (noAssignedDeliveriesMessage) noAssignedDeliveriesMessage.style.display = 'block';
                if (showRouteBtn) showRouteBtn.style.display = 'none';
            } else {
                if (noAssignedDeliveriesMessage) noAssignedDeliveriesMessage.style.display = 'none';
                if (showRouteBtn) showRouteBtn.style.display = 'block';
                snapshot.forEach((doc) => {
                    const booking = doc.data();
                    const bookingId = doc.id;
                    assignedDeliveriesData.push({ id: bookingId, data: booking }); // Store data
                    const item = createBookingItem(booking, bookingId, 'assigned');
                    if (assignedDeliveriesList) assignedDeliveriesList.appendChild(item);
                });
            }
            if (assignedDeliveriesLoading) assignedDeliveriesLoading.style.display = 'none';
            if (assignedDeliveriesError) assignedDeliveriesError.style.display = 'none';
        }, (error) => {
            console.error("Error fetching assigned deliveries (real-time):", error);
            if (assignedDeliveriesError) {
                assignedDeliveriesError.textContent = "Error loading assigned deliveries: " + error.message;
                assignedDeliveriesError.style.display = 'block';
            }
            if (assignedDeliveriesLoading) assignedDeliveriesLoading.style.display = 'none';
        });
    }

    function filterAndDisplayAvailableBookings() {
        if (!availableBookingsList) return;

        availableBookingsList.innerHTML = '';

        if (availableBookingsData.length === 0) {
            if (noAvailableBookingsMessage) noAvailableBookingsMessage.style.display = 'block';
            if (bookingsInRangeSpan) bookingsInRangeSpan.textContent = '0 bookings in range';
            return;
        }

        const selectedRadius = parseFloat(serviceRadiusSelect ? serviceRadiusSelect.value : 10);
        let filteredBookings = availableBookingsData;

        if (CURRENT_DRIVER_LOCATION && selectedRadius < 50) {
            filteredBookings = availableBookingsData.filter(booking => {
                const pickupLocation = booking.data.pickupLocation;
                if (!pickupLocation || !pickupLocation.geopoint) return false;

                const pickupLat = pickupLocation.geopoint.latitude;
                const pickupLng = pickupLocation.geopoint.longitude;
                if (typeof pickupLat !== 'number' || typeof pickupLng !== 'number') return false;

                const distance = calculateDistance(
                    CURRENT_DRIVER_LOCATION.lat,
                    CURRENT_DRIVER_LOCATION.lng,
                    pickupLat,
                    pickupLng
                );
                return distance <= selectedRadius;
            });
        }

        if (bookingsInRangeSpan) bookingsInRangeSpan.textContent = `${filteredBookings.length} bookings in range`;

        if (filteredBookings.length === 0) {
            if (noAvailableBookingsMessage) noAvailableBookingsMessage.style.display = 'block';
        } else {
            if (noAvailableBookingsMessage) noAvailableBookingsMessage.style.display = 'none';
            filteredBookings.forEach(bookingWrapper => {
                const booking = bookingWrapper.data;
                const bookingId = bookingWrapper.id;
                const item = createBookingItem(booking, bookingId, 'available');
                availableBookingsList.appendChild(item);
            });
        }
    }

    // --- Create Booking Item HTML ---
    function createBookingItem(booking, bookingId, type) {
        const item = document.createElement('div');
        item.dataset.bookingId = bookingId;

        // Safely get booking data with fallbacks
        const parcelDetails = booking.parcelDetails || booking.packageDetails || {};
        const pickupLocation = booking.pickupLocation || {};
        const dropoffLocation = booking.dropoffLocation || {};
        const recipient = booking.recipient || {};
        
        const parcelType = parcelDetails.type || 'N/A';
        const parcelWeight = parcelDetails.weightKg || parcelDetails.weight || 'N/A';
        const pickupName = pickupLocation.name || 'N/A';
        const dropoffName = dropoffLocation.name || 'N/A';
        const customerName = booking.customerName || booking.senderName || 'N/A';
        const customerPhone = booking.customerContact || booking.customerPhone || 'N/A';
        const recipientName = recipient.name || 'N/A';
        const recipientContact = recipient.contact || 'N/A';
        const specialInstructions = booking.specialInstructions || '';
        const paymentStatus = booking.paymentStatus || 'Pending';
        const fareAmount = booking.fareAmount || 0;

        if (type === 'available') {
            item.className = 'booking-card';

            // Determine distance to pickup
            let distanceHtml = '';
            if (CURRENT_DRIVER_LOCATION && pickupLocation.geopoint) {
                const distanceToPickup = calculateDistance(
                    CURRENT_DRIVER_LOCATION.lat,
                    CURRENT_DRIVER_LOCATION.lng,
                    pickupLocation.geopoint.latitude,
                    pickupLocation.geopoint.longitude
                );
                distanceHtml = `<p>Distance to Pickup: <strong>${distanceToPickup.toFixed(2)} km</strong></p>`;
            }

            item.innerHTML = `
                <div class="booking-card-header">
                    <h4><i class="fas fa-cube"></i> Booking ID: ${bookingId.substring(0, 8)}</h4>
                    <span class="fare">UGX ${parseInt(fareAmount).toLocaleString() || 'N/A'}</span>
                </div>
                <div class="booking-card-info">
                    <p><i class="fas fa-map-marker-alt"></i> Pickup: <span class="clickable-location"
                            data-lat="${pickupLocation.geopoint?.latitude || 0}"
                            data-lng="${pickupLocation.geopoint?.longitude || 0}"
                            data-booking-id="${bookingId}">${pickupName}</span></p>
                    <p><i class="fas fa-route"></i> Dropoff: <span class="clickable-location"
                            data-lat="${dropoffLocation.geopoint?.latitude || 0}"
                            data-lng="${dropoffLocation.geopoint?.longitude || 0}"
                            data-booking-id="${bookingId}">${dropoffName}</span></p>
                </div>
                ${distanceHtml}
                <div class="booking-card-actions">
                    <button class="btn danger-btn decline-booking-btn" data-id="${bookingId}">
                        <i class="fas fa-times-circle"></i> Decline
                    </button>
                    <button class="btn primary-btn accept-booking-btn" data-id="${bookingId}">
                        <i class="fas fa-check-circle"></i> Accept
                    </button>
                </div>
            `;
        } else if (type === 'assigned') {
            item.className = 'assigned-delivery-item';
            const currentStatus = booking.status || 'Driver Assigned';
            const statusClass = currentStatus.replace(/\s/g, '');

            // Determine next action button text
            let nextActionButtonText = '';
            let nextStatus = '';
            if (currentStatus === 'Driver Assigned') {
                nextActionButtonText = 'Mark as Picked Up';
                nextStatus = 'Picked Up';
            } else if (currentStatus === 'Picked Up') {
                nextActionButtonText = 'Mark as In Transit';
                nextStatus = 'In Transit';
            } else if (currentStatus === 'In Transit') {
                nextActionButtonText = 'Mark as Completed';
                nextStatus = 'Completed';
            }

            item.innerHTML = `
                <div class="assigned-delivery-item-header">
                    <h5>Booking ID: ${bookingId.substring(0, 8)}</h5>
                    <span class="status-tag ${statusClass}">${currentStatus.toUpperCase()}</span>
                </div>
                <div class="assigned-delivery-item-body">
                    <p><strong>Package:</strong> ${parcelType}, ${parcelWeight} kg</p>
                    <p><strong>Pickup:</strong> <span class="clickable-location"
                            data-lat="${pickupLocation.geopoint?.latitude || 0}"
                            data-lng="${pickupLocation.geopoint?.longitude || 0}"
                            data-booking-id="${bookingId}">${pickupName}</span></p>
                    <p><strong>Dropoff:</strong> <span class="clickable-location"
                            data-lat="${dropoffLocation.geopoint?.latitude || 0}"
                            data-lng="${dropoffLocation.geopoint?.longitude || 0}"
                            data-booking-id="${bookingId}">${dropoffName}</span></p>
                    <p><strong>Fare:</strong> UGX ${parseInt(fareAmount).toLocaleString() || 'N/A'}</p>
                </div>
                <div class="assigned-delivery-actions">
                    ${nextActionButtonText ? `
                        <button class="status-update-btn" data-id="${bookingId}" data-status="${nextStatus}">
                            <i class="fas fa-check"></i> ${nextActionButtonText}
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // Add event listeners for clickable locations
        item.querySelectorAll('.clickable-location').forEach(span => {
            span.addEventListener('click', () => {
                const lat = parseFloat(span.dataset.lat);
                const lng = parseFloat(span.dataset.lng);
                const name = span.textContent;
                const id = span.dataset.bookingId;
                if (!isNaN(lat) && !isNaN(lng)) {
                    showLocationOnMap(lat, lng, name, id);
                }
            });
        });

        if (type === 'available') {
            const acceptBtn = item.querySelector('.accept-booking-btn');
            const declineBtn = item.querySelector('.decline-booking-btn');
            if (acceptBtn) acceptBtn.addEventListener('click', () => acceptBooking(bookingId));
            if (declineBtn) declineBtn.addEventListener('click', () => declineBooking(bookingId));
        } else if (type === 'assigned') {
            const updateBtn = item.querySelector('.status-update-btn');
            if (updateBtn) {
                updateBtn.addEventListener('click', () => {
                    const newStatus = updateBtn.dataset.status;
                    if (newStatus) {
                        updateBookingStatus(bookingId, newStatus, item);
                    }
                });
            }
        }

        return item;
    }

    // New: Function to show an optimized route on the map
    function showOptimizedRoute() {
        if (!map) {
            console.warn("Map not initialized. Cannot show route.");
            return;
        }

        if (assignedDeliveriesData.length === 0) {
            alert("You have no assigned deliveries to optimize a route for.");
            return;
        }
        
        // Clear any previous routing control
        if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
        }

        // Create an array of waypoints, starting with the driver's current location
        let waypoints = [];
        if (CURRENT_DRIVER_LOCATION) {
            waypoints.push(L.latLng(CURRENT_DRIVER_LOCATION.lat, CURRENT_DRIVER_LOCATION.lng));
        } else {
            alert("Please enable location tracking to start the route from your current position.");
            return;
        }

        // Add all pickup and dropoff locations to the waypoints array
        assignedDeliveriesData.forEach(delivery => {
            const pickup = delivery.data.pickupLocation.geopoint;
            const dropoff = delivery.data.dropoffLocation.geopoint;
            
            if (pickup && pickup.latitude && pickup.longitude) {
                waypoints.push(L.latLng(pickup.latitude, pickup.longitude));
            }
            if (dropoff && dropoff.latitude && dropoff.longitude) {
                waypoints.push(L.latLng(dropoff.latitude, dropoff.longitude));
            }
        });

        // Initialize and add the routing control to the map
        routingControl = L.Routing.control({
            waypoints: waypoints,
            routeWhileDragging: true,
            geocoder: L.Control.Geocoder.nominatim(),
            showAlternatives: true,
            lineOptions: {
                styles: [{ color: '#16a085', weight: 6 }]
            }
        }).addTo(map);

        // Scroll to the map
        driverNavigationMapDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // New: Function to fetch and display vehicle details
    async function fetchAndDisplayVehicleDetails() {
        if (!CURRENT_DRIVER_ID) return;

        try {
            const userDocRef = doc(db, "users", CURRENT_DRIVER_ID);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                const vehicle = userData.vehicleDetails || {};
                
                if (vehicleMakeInput) vehicleMakeInput.value = vehicle.make || '';
                if (vehicleModelInput) vehicleModelInput.value = vehicle.model || '';
                if (licensePlateInput) licensePlateInput.value = vehicle.licensePlate || '';
                if (insuranceExpirationInput) {
                    const insuranceDate = vehicle.insuranceExpiration?.toDate();
                    if (insuranceDate) {
                        insuranceExpirationInput.value = insuranceDate.toISOString().split('T')[0];
                    } else {
                        insuranceExpirationInput.value = '';
                    }
                }
            }
        } catch (error) {
            console.error("Error fetching vehicle details:", error);
            showVehicleMessage("Failed to load vehicle details.", 'error');
        }
    }

    // New: Function to save vehicle details to Firestore
    async function saveVehicleDetails() {
        if (!CURRENT_DRIVER_ID) {
            showVehicleMessage("Error: Driver not authenticated.", 'error');
            return;
        }
        
        saveVehicleBtn.disabled = true;
        const originalText = saveVehicleBtn.innerHTML;
        saveVehicleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        const vehicleData = {
            make: vehicleMakeInput.value.trim(),
            model: vehicleModelInput.value.trim(),
            licensePlate: licensePlateInput.value.trim(),
            insuranceExpiration: insuranceExpirationInput.value ? new Date(insuranceExpirationInput.value) : null,
        };

        try {
            const userDocRef = doc(db, "users", CURRENT_DRIVER_ID);
            await updateDoc(userDocRef, {
                vehicleDetails: vehicleData
            });
            showVehicleMessage("Vehicle details saved successfully!", 'success');
        } catch (error) {
            console.error("Error saving vehicle details:", error);
            showVehicleMessage("Failed to save vehicle details. Please try again.", 'error');
        } finally {
            saveVehicleBtn.disabled = false;
            saveVehicleBtn.innerHTML = originalText;
        }
    }


    // New function to fetch driver performance metrics
    async function fetchDriverPerformance() {
        if (!CURRENT_DRIVER_ID) {
            console.warn("Driver ID not available. Cannot fetch performance.");
            return;
        }

        if (performanceLoadingEl) performanceLoadingEl.style.display = 'block';

        try {
            // Fetch the driver's performance data from a single query
            const q = query(collection(db, "bookings"), where("assignedDriver", "==", CURRENT_DRIVER_ID));
            const querySnapshot = await getDocs(q);

            let totalDeliveries = 0;
            let totalEarnings = 0;
            let totalRating = 0;
            let deliveriesWithRating = 0;

            querySnapshot.forEach((doc) => {
                const booking = doc.data();
                if (booking.status === "Completed") {
                    totalDeliveries++;
                    totalEarnings += booking.fareAmount || 0;
                    if (booking.rating) {
                        totalRating += booking.rating;
                        deliveriesWithRating++;
                    }
                }
            });

            // Update the UI
            if (totalDeliveriesEl) totalDeliveriesEl.textContent = totalDeliveries;
            if (totalEarningsEl) totalEarningsEl.textContent = `UGX ${totalEarnings.toLocaleString()}`;
            if (averageRatingEl) {
                const avgRating = deliveriesWithRating > 0 ? (totalRating / deliveriesWithRating).toFixed(1) : 'N/A';
                averageRatingEl.textContent = avgRating;
            }

            console.log(`Performance data fetched: ${totalDeliveries} deliveries, ${totalEarnings} earnings`);

        } catch (error) {
            console.error("Error fetching driver performance:", error);
            // You can add an error message to the UI here if needed
        } finally {
            if (performanceLoadingEl) performanceLoadingEl.style.display = 'none';
        }
    }


    // --- Accept Booking Function ---
    async function acceptBooking(bookingId) {
        const acceptBtn = document.querySelector(`.accept-booking-btn[data-id="${bookingId}"]`);
        if (!acceptBtn) return;

        acceptBtn.disabled = true;
        const originalText = acceptBtn.innerHTML;
        acceptBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accepting...';

        try {
            const bookingRef = doc(db, "bookings", bookingId);
            await updateDoc(bookingRef, {
                status: "Driver Assigned",
                assignedDriver: CURRENT_DRIVER_ID,
                assignmentDate: serverTimestamp(),
            });
        } catch (error) {
            console.error("Error accepting booking:", error);
            alert("Failed to accept booking. Please try again.");
            acceptBtn.disabled = false;
            acceptBtn.innerHTML = originalText;
        }
    }

    // --- Decline Booking Function ---
    async function declineBooking(bookingId) {
        const declineBtn = document.querySelector(`.decline-booking-btn[data-id="${bookingId}"]`);
        if (!declineBtn) return;

        declineBtn.disabled = true;
        const originalText = declineBtn.innerHTML;
        declineBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Declining...';

        try {
            const bookingRef = doc(db, "bookings", bookingId);
            await updateDoc(bookingRef, {
                declinedByDrivers: arrayUnion(CURRENT_DRIVER_ID)
            });
        } catch (error) {
            console.error("Error declining booking:", error);
            alert("Failed to decline booking. Please try again.");
            declineBtn.disabled = false;
            declineBtn.innerHTML = originalText;
        }
    }
    
    // --- Update Booking Status Function ---
    async function updateBookingStatus(bookingId, newStatus, itemElement) {
        const updateBtn = itemElement.querySelector('.status-update-btn');
        if (!updateBtn) return;

        const originalText = updateBtn.innerHTML;
        updateBtn.disabled = true;
        updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';

        try {
            const bookingRef = doc(db, "bookings", bookingId);
            const updateData = { status: newStatus };

            if (newStatus === 'Completed') {
                updateData.completionDate = serverTimestamp();
            }

            await updateDoc(bookingRef, updateData);
            
            // UI update will be handled automatically by the real-time listener.
            // We just reset the button state after a successful update.
            updateBtn.disabled = false;
            updateBtn.innerHTML = originalText;
            
        } catch (error) {
            console.error("Error updating booking status:", error);
            alert(`Failed to update status to ${newStatus}: ${error.message}`);
            updateBtn.disabled = false;
            updateBtn.innerHTML = originalText;
        }
    }

    // --- Authentication State Listener ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            CURRENT_DRIVER_ID = user.uid;
            try {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().isDriver) {
                    const userData = userDocSnap.data();
                    const fullName = userData.name || "Driver";
                    const firstName = fullName.split(' ')[0] || "Driver";

                    // Update desktop and mobile user name displays
                    if (userNameDisplay) userNameDisplay.textContent = firstName;
                    if (mobileUserNameDisplay) mobileUserNameDisplay.textContent = fullName;
                    
                    // Add main dashboard welcome message
                    const welcomeMessage = document.querySelector('.dashboard-header p');
                    if (welcomeMessage) {
                        welcomeMessage.textContent = `Welcome back, ${firstName}. Here's what's happening with your deliveries today.`;
                    }

                    // Initialize map and fetch data after user is authenticated and verified
                    initDriverMap();
                    fetchAndDisplayBookings();
                    fetchDriverPerformance(); // Call the new function to load performance data
                    fetchAndDisplayVehicleDetails(); // New: Fetch and display vehicle details
                    
                    // Attach location tracking listeners
                    if (startTrackingBtn) startTrackingBtn.addEventListener('click', startLocationTracking);
                    if (stopTrackingBtn) stopLocationTracking.disabled = true;
                    if (stopTrackingBtn) stopTrackingBtn.addEventListener('click', stopLocationTracking);
                    if (serviceRadiusSelect) serviceRadiusSelect.addEventListener('change', filterAndDisplayAvailableBookings);

                } else {
                    alert("Access Denied: You are not authorized to view this page.");
                    await signOut(auth);
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
                alert("Error loading user data. Please try again.");
            }
        } else {
            window.location.href = 'login.html';
        }
    });
</script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</body>
</html>
