<!-- Firebase & WhatsApp Chat Integrated Version + Full Booking Form -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FikaConnect – Book Delivery</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f9fb;
      color: #333;
    }
    .dark-mode {
      background-color: #111 !important;
      color: #e4e4e4 !important;
    }
    .card-dark {
      background-color: #222 !important;
      border-color: #333;
    }
    .container {
      max-width: 768px;
    }
    .toggle-theme {
      position: absolute;
      top: 1rem;
      right: 1rem;
    }
    .timeline-step {
      border-left: 3px solid #28a745;
      margin-left: 10px;
      padding-left: 15px;
      margin-bottom: 10px;
    }
    .whatsapp-float {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
    }
    .whatsapp-float img {
      width: 55px;
    }
  </style>
</head>
<body>
  <div class="toggle-theme">
    <button class="btn btn-outline-secondary" id="themeToggle">Toggle Dark Mode</button>
  </div>

  <div class="container mt-5">
    <!-- Booking form -->
    <form id="bookingForm">
      <div class="mb-3">
        <label class="form-label">Pickup Option</label>
        <select class="form-select" id="pickupOption">
          <option value="custom">Custom Location</option>
          <option value="mpigi">Fika Center – Mpigi</option>
          <option value="kampala">Fika Center – Kampala</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Drop-off Option</label>
        <select class="form-select" id="dropoffOption">
          <option value="custom">Custom Location</option>
          <option value="mpigi">Fika Center – Mpigi</option>
          <option value="kampala">Fika Center – Kampala</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Pickup Location</label>
        <input type="text" class="form-control" id="pickupLocation">
      </div>
      <div class="mb-3">
        <label class="form-label">Drop-off Location</label>
        <input type="text" class="form-control" id="dropoffLocation">
      </div>
      <input type="hidden" id="pickupLat">
      <input type="hidden" id="pickupLng">
      <input type="hidden" id="dropoffLat">
      <input type="hidden" id="dropoffLng">
      <div class="mb-3">
        <label class="form-label">Recipient Name</label>
        <input type="text" class="form-control" id="recipientName">
      </div>
      <div class="mb-3">
        <label class="form-label">Recipient Phone</label>
        <input type="tel" class="form-control" id="recipientPhone">
      </div>
      <div class="mb-3">
        <label class="form-label">Weight (kg)</label>
        <input type="number" class="form-control" id="weight">
      </div>
      <div class="mb-3">
        <label class="form-label">Size (e.g. small, medium, large)</label>
        <input type="text" class="form-control" id="size">
      </div>
      <div class="mb-3 form-check">
        <input class="form-check-input" type="checkbox" id="fragile">
        <label class="form-check-label" for="fragile">Fragile item</label>
      </div>
      <div class="mb-3">
        <label class="form-label">Upload Image (optional)</label>
        <input type="file" class="form-control" id="image">
      </div>
      <button type="button" class="btn btn-success" id="submitBtn">Submit Booking</button>
    </form>

    <div class="mt-5" id="timelineSection" style="display: none;">
      <h5>Delivery Timeline</h5>
      <div class="timeline-step">Request Submitted</div>
      <div class="timeline-step">Transporter Assigned</div>
      <div class="timeline-step">Goods in Transit</div>
      <div class="timeline-step">Delivered</div>
    </div>
  </div>

  <!-- WhatsApp floating icon -->
  <a class="whatsapp-float" href="https://wa.me/+256706864020" target="_blank">
    <img src="https://cdn-icons-png.flaticon.com/512/733/733585.png" alt="Chat on WhatsApp">
  </a>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDq3uO76nnqqPgPaFfXpOTEnFSXRqXneWU",
      authDomain: "fika-connect-5f844.firebaseapp.com",
      projectId: "fika-connect-5f844",
      storageBucket: "fika-connect-5f844.appspot.com",
      messagingSenderId: "492360448361",
      appId: "1:492360448361:web:4ab28b2b9828371d4b2f4a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    document.getElementById('themeToggle').onclick = () => {
      document.body.classList.toggle('dark-mode');
    };

    navigator.geolocation.getCurrentPosition(pos => {
      document.getElementById('pickupLat').value = pos.coords.latitude;
      document.getElementById('pickupLng').value = pos.coords.longitude;
    });

    document.getElementById('submitBtn').onclick = async () => {
      const imageFile = document.getElementById('image').files[0];
      const bookingData = {
        pickupOption: document.getElementById('pickupOption').value,
        dropoffOption: document.getElementById('dropoffOption').value,
        pickupLocation: document.getElementById('pickupLocation').value,
        dropoffLocation: document.getElementById('dropoffLocation').value,
        pickupLat: document.getElementById('pickupLat').value,
        pickupLng: document.getElementById('pickupLng').value,
        dropoffLat: document.getElementById('dropoffLat').value,
        dropoffLng: document.getElementById('dropoffLng').value,
        recipientName: document.getElementById('recipientName').value,
        recipientPhone: document.getElementById('recipientPhone').value,
        weight: document.getElementById('weight').value,
        size: document.getElementById('size').value,
        fragile: document.getElementById('fragile').checked,
        imageUrl: '',
        createdAt: new Date().toISOString()
      };

    try {
        if (imageFile) {
          const storageRef = storage.ref().child('goods/' + imageFile.name);
          const snapshot = await storageRef.put(imageFile);
          bookingData.imageUrl = await snapshot.ref.getDownloadURL();
        }

        const docRef = await db.collection("bookings").add(bookingData);
        console.log("Document written with ID: ", docRef.id);

        alert("Delivery booked successfully! Redirecting to active deliveries.");
        window.location.href = 'sender-active-deliveries.html'; // <--- THIS LINE!
      } catch (e) {
        console.error("Error adding document: ", e);
        alert("Error booking delivery: " + e.message);
      }


    };


  </script>
</body>
</html>
