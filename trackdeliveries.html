<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookings Management - Fika Connect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIINfQ7oY0QLfLpS2LCf7saKFD7HL7o6SRM=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --primary-color: #16a085;
            --primary-dark: #12876f;
            --primary-light: #e6f6f3;
            --secondary-color: #3498db;
            --dark-bg: #f4f7f6;
            --light-bg: #ffffff;
            --dark-text: #2c3e50;
            --light-text: #7f8c8d;
            --white: #ffffff;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --border-color: #e0e6e8;
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        body.dark-mode {
            --primary-color: #48c9b0;
            --primary-dark: #37a790;
            --primary-light: #2a3c39;
            --secondary-color: #5dade2;
            --dark-bg: #121212;
            --light-bg: #1e1e1e;
            --dark-text: #e0e0e0;
            --light-text: #a0a0a0;
            --white: #2c3e50;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            --border-color: #333;
        }

        /* Global Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: var(--dark-text);
            line-height: 1.6;
            transition: background-color var(--transition), color var(--transition);
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Navigation */
        .top-nav {
            padding: 15px 0;
            background-color: var(--light-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        .nav-left, .nav-center, .nav-right {
            display: flex;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--dark-bg);
            border-radius: 50px;
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            width: 300px;
        }
        .search-bar i {
            color: var(--light-text);
        }
        .search-bar input {
            border: none;
            background: transparent;
            padding: 0 10px;
            color: var(--dark-text);
            width: 100%;
        }
        .search-bar input:focus {
            outline: none;
        }
        .nav-right > * {
            margin-left: 20px;
        }
        .notification-bell, .theme-toggle {
            font-size: 1.2rem;
            color: var(--light-text);
            cursor: pointer;
            position: relative;
            transition: var(--transition);
        }
        .notification-bell .badge {
            position: absolute;
            top: -5px;
            right: -8px;
            background-color: #e74c3c;
            color: white;
            font-size: 0.7rem;
            padding: 3px 6px;
            border-radius: 50%;
        }
        .nav-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            position: relative;
        }
        .profile-info {
            display: flex;
            flex-direction: column;
            text-align: right;
        }
        .profile-name {
            font-weight: 600;
            color: var(--dark-text);
        }
        .profile-role {
            font-size: 0.8rem;
            color: var(--light-text);
        }
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .dropdown-arrow {
            color: var(--light-text);
            transition: transform var(--transition);
        }
        .nav-profile.active .dropdown-arrow {
            transform: rotate(180deg);
        }
        .profile-dropdown .dropdown-content {
            display: none;
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background-color: var(--light-bg);
            min-width: 180px;
            box-shadow: var(--card-shadow);
            z-index: 100;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .nav-profile.active .dropdown-content {
            display: block;
        }
        .profile-dropdown .dropdown-content a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: var(--dark-text);
            text-decoration: none;
            transition: var(--transition);
        }
        .profile-dropdown .dropdown-content a:hover {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }

        /* Container & Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .booking-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--light-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }
        .booking-page-header h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }
        .booking-list-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        @media (min-width: 768px) {
            .booking-list-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        @media (min-width: 1024px) {
            .booking-list-container {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        .section-card {
            padding: 20px;
            background-color: var(--light-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }
        .section-card h3 {
            margin-bottom: 15px;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Bookings & Deliveries */
        .booking-card, .assigned-delivery-item, .completed-delivery-item {
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            transition: var(--transition);
        }
        .booking-card:hover, .assigned-delivery-item:hover, .completed-delivery-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        .booking-card-header, .assigned-delivery-item-header, .completed-delivery-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .booking-card-header h4, .assigned-delivery-item-header h5, .completed-delivery-item-header h5 {
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        .fare {
            font-weight: 700;
            color: var(--primary-color);
        }
        .booking-card-info p, .assigned-delivery-item-body p, .completed-delivery-item-body p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: var(--light-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .booking-card-info p i, .assigned-delivery-item-body p i, .completed-delivery-item-body p i {
            width: 20px;
            color: var(--primary-color);
        }
        .booking-card-actions, .assigned-delivery-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .primary-btn {
            background-color: var(--primary-color);
            color: white;
        }
        .primary-btn:hover {
            background-color: var(--primary-dark);
        }
        .danger-btn {
            background-color: #e74c3c;
            color: white;
        }
        .danger-btn:hover {
            background-color: #c0392b;
        }
        .details-dropdown {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            display: none;
        }
        .details-dropdown.open {
            display: block;
        }
        .details-dropdown p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: var(--dark-text);
        }
        .details-dropdown p i {
            width: 20px;
            color: var(--primary-color);
        }
        .toggle-details-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 5px;
            display: block;
            text-align: right;
            width: 100%;
        }
        .toggle-details-btn i {
            transition: transform 0.3s ease;
        }
        .toggle-details-btn.open i {
            transform: rotate(180deg);
        }
        .status-tag {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }
        .status-tag.DriverAssigned { background-color: #3498db; }
        .status-tag.PickedUp { background-color: #f39c12; }
        .status-tag.InTransit { background-color: #2980b9; }
        .status-tag.Completed { background-color: var(--primary-color); }
        .status-tag.PODCaptured { background-color: #2ecc71; }

        .no-items-message, .error-message, .loading-spinner {
            text-align: center;
            color: var(--light-text);
            margin-top: 20px;
            font-style: italic;
        }
        .booking-message {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        .success-message {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }
        .error-message {
            background-color: #fde8e8;
            color: #c0392b;
            padding: 10px;
            border-radius: 8px;
        }

        /* Custom modal for alerts */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--light-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal-content p {
            margin-bottom: 20px;
            color: var(--dark-text);
        }
        .modal-content button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* POD Modal Specific Styles */
        #podModal .modal-content {
            max-width: 600px;
        }
        #signaturePad {
            width: 100%;
            height: 250px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background-color: var(--dark-bg);
            touch-action: none;
        }
        #pod-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        .earnings-dashboard {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin-bottom: 20px;
            text-align: center;
            padding: 15px;
            background-color: var(--dark-bg);
            border-radius: var(--border-radius);
        }
        .dashboard-item {
            flex: 1;
        }
        .dashboard-item h4 {
            font-size: 1rem;
            color: var(--light-text);
            margin-bottom: 5px;
        }
        .dashboard-item p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* Map specific styles */
        #availableBookingsMap, #navigationMap {
            height: 400px;
            width: 100%;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        .map-section-off-duty, .bookings-section-off-duty {
            opacity: 0.5;
            pointer-events: none;
        }
        .map-section-off-duty h3::after, .bookings-section-off-duty h3::after {
            content: " (Off Duty)";
            font-size: 0.8rem;
            color: #e74c3c;
            margin-left: 10px;
        }

        .hidden {
            display: none;
        }
        [disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

    </style>
</head>
<body>
    <header class="top-nav">
        <div class="nav-container">
            <div class="nav-left">
                <a href="driver-dashboard.html" class="logo">
                    <i class="fas fa-truck-loading"></i>
                    Fika Connect
                </a>
            </div>
            <div class="nav-center">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search deliveries, drivers, etc.">
                </div>
            </div>
            <div class="nav-right">
                <div class="notification-bell">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </div>
                <div id="navProfile" class="nav-profile profile-dropdown">
                    <div class="profile-info">
                        <span id="userNameDisplay" class="profile-name">...</span>
                        <span class="profile-role">Driver</span>
                    </div>
                    <img src="https://via.placeholder.com/40" alt="Profile" class="profile-img">
                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                    <div class="dropdown-content">
                        <a href="#"><i class="fas fa-user-circle"></i> Profile</a>
                        <a href="#"><i class="fas fa-cog"></i> Settings</a>
                        <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
                <button id="themeToggle" class="theme-toggle"><i class="fas fa-moon"></i></button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="booking-page-header">
            <h2>Bookings Management</h2>
            <div class="flex items-center gap-4">
                <button id="availabilityToggleBtn" class="btn primary-btn" disabled><i class="fas fa-toggle-on"></i> Loading...</button>
            </div>
        </div>

        <div class="booking-list-container">
            <div id="availableBookingsMapCard" class="section-card">
                <h3><i class="fas fa-map-marker-alt"></i> Map of Available Bookings</h3>
                <div id="availableBookingsMap"></div>
            </div>

            <div id="mapNavigationCard" class="section-card hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3><i class="fas fa-route"></i> Turn-by-Turn Navigation</h3>
                    <button id="backToBookingsBtn" class="btn danger-btn"><i class="fas fa-times"></i> Stop Navigation</button>
                </div>
                <div id="navigationMap"></div>
            </div>

            <div id="availableBookingsListCard" class="section-card">
                <h3><i class="fas fa-list-ul"></i> Available Bookings</h3>
                <div id="availableBookingsLoading" class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Loading available bookings...
                </div>
                <div id="noAvailableBookingsMessage" class="no-items-message" style="display: none;">
                    <p>No available bookings at this time.</p>
                </div>
                <div id="availableBookingsOffDutyMessage" class="no-items-message" style="display: none;">
                    <p>You are currently Off Duty. Switch to On Duty to see available bookings.</p>
                </div>
                <div id="availableBookingsError" class="error-message" style="display: none;"></div>
                <div id="availableBookingsList">
                </div>
            </div>

            <div id="assignedDeliveriesListCard" class="section-card">
                <h3><i class="fas fa-truck"></i> My Assigned Deliveries</h3>
                <div id="assignedDeliveriesLoading" class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Loading your assigned deliveries...
                </div>
                <div id="noAssignedDeliveriesMessage" class="no-items-message" style="display: none;">
                    <p>You currently have no assigned deliveries.</p>
                </div>
                <div id="assignedDeliveriesError" class="error-message" style="display: none;"></div>
                <div id="assignedDeliveriesList">
                </div>
            </div>
            
            <div id="completedDeliveriesCard" class="section-card">
                <h3><i class="fas fa-history"></i> Earnings & History</h3>
                <div class="earnings-dashboard">
                    <div class="dashboard-item">
                        <h4>Total Deliveries</h4>
                        <p id="totalDeliveries">0</p>
                    </div>
                    <div class="dashboard-item">
                        <h4>Total Earnings</h4>
                        <p id="totalEarnings">UGX 0</p>
                    </div>
                </div>
                <div id="completedDeliveriesLoading" class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Loading completed deliveries...
                </div>
                <div id="noCompletedDeliveriesMessage" class="no-items-message" style="display: none;">
                    <p>You have not completed any deliveries yet.</p>
                </div>
                <div id="completedDeliveriesError" class="error-message" style="display: none;"></div>
                <div id="completedDeliveriesList">
                </div>
            </div>
        </div>
    </div>

    <div id="customModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <button id="modalCloseBtn">OK</button>
        </div>
    </div>

    <div id="podModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Proof of Delivery</h3>
            <p class="text-gray-600 mb-4">Please have the recipient sign below to confirm delivery.</p>
            <canvas id="signaturePad"></canvas>
            <div id="pod-actions">
                <button id="clearSignatureBtn" class="btn danger-btn"><i class="fas fa-eraser"></i> Clear</button>
                <button id="confirmPodBtn" class="btn primary-btn"><i class="fas fa-check"></i> Confirm Delivery</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, updateDoc, arrayUnion, collection, query, where, onSnapshot, serverTimestamp, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDq3uO76nnqqPgPaFfXpOTEnFSXRqXneWU",
            authDomain: "fika-connect-5f844.firebaseapp.com",
            projectId: "fika-connect-5f844",
            storageBucket: "fika-connect-5f844.appspot.com",
            messagingSenderId: "492360448361",
            appId: "1:492360448361:web:4ab28b2b9828371d4b2f4a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const userNameDisplay = document.getElementById('userNameDisplay');
        const logoutBtn = document.getElementById('logoutBtn');
        const themeToggle = document.getElementById('themeToggle');
        const navProfile = document.getElementById('navProfile');
        const body = document.body;

        const availableBookingsList = document.getElementById('availableBookingsList');
        const availableBookingsLoading = document.getElementById('availableBookingsLoading');
        const noAvailableBookingsMessage = document.getElementById('noAvailableBookingsMessage');
        const availableBookingsOffDutyMessage = document.getElementById('availableBookingsOffDutyMessage');
        const availableBookingsError = document.getElementById('availableBookingsError');
        const availableBookingsMapCard = document.getElementById('availableBookingsMapCard');
        const availableBookingsListCard = document.getElementById('availableBookingsListCard');
        
        const assignedDeliveriesListCard = document.getElementById('assignedDeliveriesListCard');
        const assignedDeliveriesList = document.getElementById('assignedDeliveriesList');
        const assignedDeliveriesLoading = document.getElementById('assignedDeliveriesLoading');
        const noAssignedDeliveriesMessage = document.getElementById('noAssignedDeliveriesMessage');
        const assignedDeliveriesError = document.getElementById('assignedDeliveriesError');

        const completedDeliveriesCard = document.getElementById('completedDeliveriesCard');
        const completedDeliveriesList = document.getElementById('completedDeliveriesList');
        const completedDeliveriesLoading = document.getElementById('completedDeliveriesLoading');
        const noCompletedDeliveriesMessage = document.getElementById('noCompletedDeliveriesMessage');
        const completedDeliveriesError = document.getElementById('completedDeliveriesError');
        const totalDeliveriesElement = document.getElementById('totalDeliveries');
        const totalEarningsElement = document.getElementById('totalEarnings');

        const availabilityToggleBtn = document.getElementById('availabilityToggleBtn');

        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        
        const mapNavigationCard = document.getElementById('mapNavigationCard');
        const navigationMapContainer = document.getElementById('navigationMap');
        const backToBookingsBtn = document.getElementById('backToBookingsBtn');

        const podModal = document.getElementById('podModal');
        const signaturePad = document.getElementById('signaturePad');
        const clearSignatureBtn = document.getElementById('clearSignatureBtn');
        const confirmPodBtn = document.getElementById('confirmPodBtn');
        const signatureCtx = signaturePad.getContext('2d');
        let isDrawing = false;
        let currentPodBookingId = null;

        let map;
        let navigationMap;
        const markers = new Map();
        let routingControl = null;
        let CURRENT_DRIVER_ID = null;
        let availableBookingsUnsubscribe = null;
        let assignedDeliveriesUnsubscribe = null;
        let completedDeliveriesUnsubscribe = null;
        let driverProfileUnsubscribe = null;
        let locationWatchId = null; // New variable to store the watchPosition ID


        // --- UI & Event Handlers ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                body.classList.add('dark-mode');
                updateThemeIcons();
            }

            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }

            if (navProfile) {
                navProfile.addEventListener('click', (event) => {
                    event.stopPropagation();
                    navProfile.classList.toggle('active');
                });
            }
            
            document.addEventListener('click', (event) => {
                if (navProfile && navProfile.classList.contains('active') && !navProfile.contains(event.target)) {
                    navProfile.classList.remove('active');
                }
            });

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    await signOut(auth);
                    window.location.href = 'login.html';
                });
            }

            initMap(); // Call map initialization on page load
        });

        function toggleTheme() {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcons();
        }

        function updateThemeIcons() {
            const isDark = body.classList.contains('dark-mode');
            if (themeToggle) {
                const icon = themeToggle.querySelector('i');
                if (isDark) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            }
        }

        // --- Map Initialization ---
        function initMap() {
            try {
                if (!map) {
                    map = L.map('availableBookingsMap').setView([0.31628, 32.58219], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                }
            } catch (error) {
                console.error("Error initializing map:", error);
                const mapContainer = document.getElementById('availableBookingsMap');
                if (mapContainer) {
                    mapContainer.innerHTML = '<div class="error-message">Error loading map. Please check your internet connection.</div>';
                }
            }
        }

        // --- Utility Functions ---
        function showModal(message) {
            modalMessage.textContent = message;
            customModal.classList.add('open');
        }

        modalCloseBtn.addEventListener('click', () => {
            customModal.classList.remove('open');
        });

        function createBookingItem(booking, bookingId, type) {
            const item = document.createElement('div');
            item.dataset.bookingId = bookingId;

            const parcelDetails = booking.parcelDetails || booking.packageDetails || {};
            const pickupLocation = booking.pickupLocation || {};
            const dropoffLocation = booking.dropoffLocation || {};
            const recipient = booking.recipient || {};
            
            const parcelType = parcelDetails.type || 'N/A';
            const parcelWeight = parcelDetails.weightKg || parcelDetails.weight || 'N/A';
            const pickupName = pickupLocation.name || 'N/A';
            const dropoffName = dropoffLocation.name || 'N/A';
            const customerName = booking.customerName || booking.senderName || 'N/A';
            const customerPhone = booking.customerContact || booking.customerPhone || 'N/A';
            const recipientName = recipient.name || 'N/A';
            const recipientContact = recipient.contact || 'N/A';
            const specialInstructions = booking.specialInstructions || '';
            const paymentStatus = booking.paymentStatus || 'Pending';
            const fareAmount = booking.fareAmount || 0;
            const podCaptured = !!(booking.proofOfDelivery && booking.proofOfDelivery.signature);
            const hasInstructions = !!(specialInstructions);

            if (type === 'available') {
                item.className = 'booking-card';
                item.innerHTML = `
                    <div class="booking-card-header">
                        <h4><i class="fas fa-cube"></i> Booking ID: ${bookingId.substring(0, 8)}</h4>
                        <span class="fare">UGX ${parseInt(fareAmount).toLocaleString() || 'N/A'}</span>
                    </div>
                    <div class="booking-card-info">
                        <p><i class="fas fa-map-marker-alt"></i> Pickup: ${pickupName}</p>
                        <p><i class="fas fa-route"></i> Dropoff: ${dropoffName}</p>
                    </div>
                    <div class="details-dropdown">
                        <p><strong>Package Type:</strong> ${parcelType}</p>
                        <p><strong>Package Weight:</strong> ${parcelWeight} kg</p>
                        <p><strong>Customer:</strong> ${customerName}</p>
                        <p><strong>Customer Phone:</strong> <a href="tel:${customerPhone}">${customerPhone}</a></p>
                        <p><strong>Recipient:</strong> ${recipientName}</p>
                        <p><strong>Recipient Phone:</strong> <a href="tel:${recipientContact}">${recipientContact}</a></p>
                        ${hasInstructions ? `<p><strong>Instructions:</strong> ${specialInstructions}</p>` : ''}
                        <p><strong>Payment Status:</strong> ${paymentStatus}</p>
                    </div>
                    <button class="toggle-details-btn"><i class="fas fa-chevron-down"></i> Details</button>
                    <div class="booking-card-actions">
                        ${customerPhone ? `
                        <button class="btn primary-btn call-customer-btn" data-phone="${customerPhone}">
                            <i class="fas fa-phone"></i> Call Customer
                        </button>
                        ` : ''}
                        <button class="btn danger-btn decline-booking-btn" data-id="${bookingId}">
                            <i class="fas fa-times-circle"></i> Decline
                        </button>
                        <button class="btn primary-btn accept-booking-btn" data-id="${bookingId}">
                            <i class="fas fa-check-circle"></i> Accept
                        </button>
                    </div>
                `;
            } else if (type === 'assigned') {
                item.className = 'assigned-delivery-item';
                const currentStatus = booking.status || 'Driver Assigned';
                const statusClass = currentStatus.replace(/\s/g, '');

                let nextActionButtonText = '';
                let nextStatus = '';
                let nextActionIcon = '';
                
                if (currentStatus === 'Driver Assigned') {
                    nextActionButtonText = 'Mark as Picked Up';
                    nextStatus = 'Picked Up';
                    nextActionIcon = 'fa-boxes-packing';
                } else if (currentStatus === 'Picked Up') {
                    nextActionButtonText = 'Mark as In Transit';
                    nextStatus = 'In Transit';
                    nextActionIcon = 'fa-person-running';
                } else if (currentStatus === 'In Transit') {
                    nextActionButtonText = 'Mark as Completed';
                    nextStatus = 'Completed';
                    nextActionIcon = 'fa-check';
                }

                item.innerHTML = `
                    <div class="assigned-delivery-item-header">
                        <h5>Booking ID: ${bookingId.substring(0, 8)}</h5>
                        <span class="status-tag ${statusClass}">${currentStatus.toUpperCase()}</span>
                    </div>
                    <div class="assigned-delivery-item-body">
                        <p><strong>Package:</strong> ${parcelType}, ${parcelWeight} kg</p>
                        <p><strong>Pickup:</strong> ${pickupName}</p>
                        <p><strong>Dropoff:</strong> ${dropoffName}</p>
                    </div>
                    <div class="details-dropdown">
                        <p><strong>Customer:</strong> ${customerName}</p>
                        <p><strong>Customer Phone:</strong> <a href="tel:${customerPhone}">${customerPhone}</a></p>
                        <p><strong>Recipient:</strong> ${recipientName}</p>
                        <p><strong>Recipient Phone:</strong> <a href="tel:${recipientContact}">${recipientContact}</a></p>
                        <p><strong>Fare:</strong> UGX ${parseInt(fareAmount).toLocaleString() || 'N/A'}</p>
                        ${hasInstructions ? `<p><strong>Instructions:</strong> ${specialInstructions}</p>` : ''}
                    </div>
                    <button class="toggle-details-btn"><i class="fas fa-chevron-down"></i> Details</button>
                    <div class="assigned-delivery-actions">
                        ${nextActionButtonText && nextStatus !== 'Completed' ? `
                            <button class="status-update-btn btn primary-btn" data-id="${bookingId}" data-status="${nextStatus}">
                                <i class="fas ${nextActionIcon}"></i> ${nextActionButtonText}
                            </button>
                        ` : ''}
                        
                        ${(currentStatus === 'Picked Up' || currentStatus === 'In Transit') && !podCaptured ? `
                            <button class="proof-of-delivery-btn btn primary-btn" data-id="${bookingId}">
                                <i class="fas fa-pen-to-square"></i> Proof of Delivery
                            </button>
                        ` : ''}

                        ${currentStatus === 'In Transit' && podCaptured ? `
                            <button class="status-update-btn btn primary-btn" data-id="${bookingId}" data-status="Completed" data-pod-captured="true">
                                <i class="fas fa-check"></i> Mark as Completed
                            </button>
                        ` : ''}
                        
                        ${customerPhone ? `
                        <button class="btn primary-btn call-customer-btn" data-phone="${customerPhone}">
                            <i class="fas fa-phone"></i> Call Customer
                        </button>
                        ` : ''}
                        <button class="btn primary-btn navigate-btn" data-pickup-lat="${pickupLocation.latitude}" data-pickup-lng="${pickupLocation.longitude}" data-dropoff-lat="${dropoffLocation.latitude}" data-dropoff-lng="${dropoffLocation.longitude}">
                            <i class="fas fa-road"></i> Navigate
                        </button>
                    </div>
                `;
            } else if (type === 'completed') {
                 item.className = 'completed-delivery-item';
                 const completionDate = booking.completionDate ? new Date(booking.completionDate.seconds * 1000).toLocaleDateString() : 'N/A';
                 item.innerHTML = `
                    <div class="completed-delivery-item-header">
                        <h5>Booking ID: ${bookingId.substring(0, 8)}</h5>
                        <span class="fare">UGX ${parseInt(fareAmount).toLocaleString() || 'N/A'}</span>
                    </div>
                    <div class="completed-delivery-item-body">
                        <p><i class="fas fa-calendar-check"></i> Completed on: ${completionDate}</p>
                        <p><i class="fas fa-map-marker-alt"></i> From: ${pickupName}</p>
                        <p><i class="fas fa-route"></i> To: ${dropoffName}</p>
                    </div>
                `;
            }

            const toggleBtn = item.querySelector('.toggle-details-btn');
            const details = item.querySelector('.details-dropdown');
            if (toggleBtn && details) {
                toggleBtn.addEventListener('click', () => {
                    details.classList.toggle('open');
                    toggleBtn.classList.toggle('open');
                });
            }
            
            if (type === 'available') {
                const acceptBtn = item.querySelector('.accept-booking-btn');
                const declineBtn = item.querySelector('.decline-booking-btn');
                const callBtn = item.querySelector('.call-customer-btn');
                if (acceptBtn) acceptBtn.addEventListener('click', () => acceptBooking(bookingId));
                if (declineBtn) declineBtn.addEventListener('click', () => declineBooking(bookingId));
                if (callBtn) callBtn.addEventListener('click', () => callContact(callBtn.dataset.phone));
            } else if (type === 'assigned') {
                const updateBtn = item.querySelector('.status-update-btn');
                const callBtn = item.querySelector('.call-customer-btn');
                const navigateBtn = item.querySelector('.navigate-btn');
                const podBtn = item.querySelector('.proof-of-delivery-btn');

                if (updateBtn) {
                    updateBtn.addEventListener('click', () => {
                        const newStatus = updateBtn.dataset.status;
                        const podCaptured = updateBtn.dataset.podCaptured === 'true';
                        
                        if (newStatus === 'Completed' && !podCaptured) {
                            return showModal("Please capture proof of delivery before marking as completed.");
                        }
                        if (newStatus) {
                            updateBookingStatus(bookingId, newStatus, item);
                        }
                    });
                }
                if (callBtn) callBtn.addEventListener('click', () => callContact(callBtn.dataset.phone));
                if (navigateBtn) {
                    navigateBtn.addEventListener('click', () => {
                        const pickupLat = parseFloat(navigateBtn.dataset.pickupLat);
                        const pickupLng = parseFloat(navigateBtn.dataset.pickupLng);
                        const dropoffLat = parseFloat(navigateBtn.dataset.dropoffLat);
                        const dropoffLng = parseFloat(navigateBtn.dataset.dropoffLng);

                        if (pickupLat && pickupLng && dropoffLat && dropoffLng) {
                            startNavigation([pickupLat, pickupLng], [dropoffLat, dropoffLng]);
                        } else {
                            showModal("Navigation data is incomplete for this booking.");
                        }
                    });
                }
                if (podBtn) {
                    podBtn.addEventListener('click', () => {
                        showPodModal(bookingId);
                    });
                }
            }

            return item;
        }

        // --- Navigation Logic ---
        function startNavigation(pickupCoords, dropoffCoords) {
            document.querySelectorAll('.section-card').forEach(card => card.classList.add('hidden'));
            mapNavigationCard.classList.remove('hidden');

            if (!navigationMap) {
                navigationMap = L.map('navigationMap').setView(pickupCoords, 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(navigationMap);
            } else {
                if (routingControl) {
                    navigationMap.removeControl(routingControl);
                    routingControl = null;
                }
                navigationMap.setView(pickupCoords, 15);
            }

            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(pickupCoords[0], pickupCoords[1]),
                    L.latLng(dropoffCoords[0], dropoffCoords[1])
                ],
                routeWhileDragging: false,
                localStorage: true
            }).addTo(navigationMap);
        }

        function stopNavigation() {
            document.querySelectorAll('.section-card').forEach(card => card.classList.remove('hidden'));
            mapNavigationCard.classList.add('hidden');

            if (routingControl) {
                navigationMap.removeControl(routingControl);
                routingControl = null;
            }
        }

        backToBookingsBtn.addEventListener('click', stopNavigation);

        // --- Proof of Delivery (POD) Logic ---
        function showPodModal(bookingId) {
            currentPodBookingId = bookingId;
            podModal.classList.add('open');
            clearSignature();
        }

        function closePodModal() {
            podModal.classList.remove('open');
            currentPodBookingId = null;
        }

        function clearSignature() {
            signatureCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
            signatureCtx.fillStyle = '#f9f9f9';
            signatureCtx.fillRect(0, 0, signaturePad.width, signaturePad.height);
            signatureCtx.strokeStyle = '#2c3e50';
            signatureCtx.lineWidth = 2;
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = signaturePad.getBoundingClientRect();
            const x = (e.touches?.[0]?.clientX || e.clientX) - rect.left;
            const y = (e.touches?.[0]?.clientY || e.clientY) - rect.top;
            signatureCtx.lineTo(x, y);
            signatureCtx.stroke();
        }

        signaturePad.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const rect = signaturePad.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            signatureCtx.beginPath();
            signatureCtx.moveTo(x, y);
        });
        signaturePad.addEventListener('mousemove', draw);
        signaturePad.addEventListener('mouseup', () => isDrawing = false);
        signaturePad.addEventListener('mouseout', () => isDrawing = false);

        signaturePad.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isDrawing = true;
            const rect = signaturePad.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left;
            const y = e.touches[0].clientY - rect.top;
            signatureCtx.beginPath();
            signatureCtx.moveTo(x, y);
        });
        signaturePad.addEventListener('touchmove', (e) => {
            e.preventDefault();
            draw(e);
        });
        signaturePad.addEventListener('touchend', () => isDrawing = false);

        clearSignatureBtn.addEventListener('click', clearSignature);

        confirmPodBtn.addEventListener('click', async () => {
            if (!currentPodBookingId) {
                return showModal("Error: No booking ID associated with this delivery.");
            }

            const signatureDataURL = signaturePad.toDataURL('image/png');
            if (signatureDataURL.length < 200) {
                return showModal("Please have the recipient provide a signature.");
            }

            confirmPodBtn.disabled = true;
            const originalText = confirmPodBtn.innerHTML;
            confirmPodBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const bookingRef = doc(db, "bookings", currentPodBookingId);
                await updateDoc(bookingRef, {
                    proofOfDelivery: {
                        signature: signatureDataURL,
                        timestamp: serverTimestamp()
                    }
                });
                showModal("Proof of Delivery captured successfully!");
                closePodModal();
            } catch (error) {
                console.error("Error confirming POD:", error);
                showModal("Failed to save proof of delivery. Please try again.");
            } finally {
                confirmPodBtn.disabled = false;
                confirmPodBtn.innerHTML = originalText;
            }
        });

        // --- NEW: Real-time Location Tracking ---
        function startLocationTracking() {
            if (!("geolocation" in navigator)) {
                return showModal("Geolocation is not supported by your browser. Location tracking will not be available.");
            }

            // Options for watchPosition
            const options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };

            // Start watching the driver's position
            locationWatchId = navigator.geolocation.watchPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    const driverLocationRef = doc(db, "driverLocations", CURRENT_DRIVER_ID);
                    try {
                        await setDoc(driverLocationRef, {
                            latitude: latitude,
                            longitude: longitude,
                            timestamp: serverTimestamp(),
                            isAvailable: true // Keep this flag in the location doc as well
                        });
                        console.log("Location updated:", latitude, longitude);
                    } catch (error) {
                        console.error("Error updating location in Firestore:", error);
                    }
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    showModal(`Error getting your location: ${error.message}. Location tracking will be disabled.`);
                    stopLocationTracking();
                },
                options
            );
        }

        async function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            if (CURRENT_DRIVER_ID) {
                const driverLocationRef = doc(db, "driverLocations", CURRENT_DRIVER_ID);
                try {
                    // Delete the location doc or just mark as unavailable
                    await deleteDoc(driverLocationRef);
                } catch (error) {
                    console.error("Error deleting driver location:", error);
                }
            }
        }
        
        // --- Availability Toggle Logic ---
        async function toggleAvailability() {
            if (!CURRENT_DRIVER_ID) return showModal("Authentication error. Please refresh the page.");

            const driverProfileRef = doc(db, "users", CURRENT_DRIVER_ID);
            try {
                // Fetch current status to toggle
                const docSnap = await getDoc(driverProfileRef);
                if (docSnap.exists()) {
                    const currentStatus = docSnap.data().isAvailable;
                    const newStatus = !currentStatus;
                    await updateDoc(driverProfileRef, { isAvailable: newStatus });
                    
                    if (newStatus) {
                        startLocationTracking();
                    } else {
                        stopLocationTracking();
                    }
                } else {
                    showModal("Driver profile not found. Cannot toggle availability.");
                }
            } catch (error) {
                console.error("Error toggling driver availability:", error);
                showModal("Failed to update availability. Please try again.");
            }
        }
        
        function updateAvailabilityUI(isAvailable) {
            if (isAvailable) {
                availabilityToggleBtn.innerHTML = '<i class="fas fa-toggle-on"></i> Go Off Duty';
                availabilityToggleBtn.classList.remove('danger-btn');
                availabilityToggleBtn.classList.add('primary-btn');

                availableBookingsMapCard.classList.remove('map-section-off-duty');
                availableBookingsListCard.classList.remove('bookings-section-off-duty');
                availableBookingsOffDutyMessage.style.display = 'none';
                
                // If the user is now On Duty, start fetching available bookings
                if (!availableBookingsUnsubscribe) {
                    fetchAvailableBookings();
                }

            } else {
                availabilityToggleBtn.innerHTML = '<i class="fas fa-toggle-off"></i> Go On Duty';
                availabilityToggleBtn.classList.remove('primary-btn');
                availabilityToggleBtn.classList.add('danger-btn');
                
                availableBookingsMapCard.classList.add('map-section-off-duty');
                availableBookingsListCard.classList.add('bookings-section-off-duty');
                availableBookingsOffDutyMessage.style.display = 'block';

                if (availableBookingsUnsubscribe) {
                    availableBookingsUnsubscribe();
                    availableBookingsUnsubscribe = null;
                }
                if (availableBookingsList) availableBookingsList.innerHTML = '';
                if (noAvailableBookingsMessage) noAvailableBookingsMessage.style.display = 'none';
                if (markers) {
                    markers.forEach(marker => map.removeLayer(marker));
                    markers.clear();
                }
            }
        }
        
        function fetchAvailableBookings() {
            // Unsubscribe from previous listener if it exists
            if (availableBookingsUnsubscribe) {
                availableBookingsUnsubscribe();
            }

            // Show loading spinner for available bookings
            if (availableBookingsLoading) availableBookingsLoading.style.display = 'block';
            if (availableBookingsError) availableBookingsError.style.display = 'none';

            const availableQ = query(
                collection(db, "bookings"),
                where("status", "==", "Pending Driver Assignment")
            );

            availableBookingsUnsubscribe = onSnapshot(availableQ, (snapshot) => {
                if (availableBookingsList) availableBookingsList.innerHTML = '';
                
                markers.forEach(marker => map.removeLayer(marker));
                markers.clear();
    
                if (snapshot.empty) {
                    if (noAvailableBookingsMessage) noAvailableBookingsMessage.style.display = 'block';
                } else {
                    if (noAvailableBookingsMessage) noAvailableBookingsMessage.style.display = 'none';
                    const bookings = [];
                    snapshot.forEach((doc) => {
                        const bookingData = doc.data();
                        if (!bookingData.declinedByDrivers || !bookingData.declinedByDrivers.includes(CURRENT_DRIVER_ID)) {
                            bookings.push({ id: doc.id, ...bookingData });
                        }
                    });
                    
                    bookings.sort((a, b) => {
                        const dateA = a.bookingDate ? a.bookingDate.toDate().getTime() : 0;
                        const dateB = b.bookingDate ? b.bookingDate.toDate().getTime() : 0;
                        return dateA - dateB;
                    });
                    
                    bookings.forEach(booking => {
                        const item = createBookingItem(booking, booking.id, 'available');
                        if (availableBookingsList) availableBookingsList.appendChild(item);
    
                        const pickupLocation = booking.pickupLocation || {};
                        if (map && pickupLocation.geopoint?.latitude && pickupLocation.geopoint?.longitude) {
                            const marker = L.marker([pickupLocation.geopoint.latitude, pickupLocation.geopoint.longitude]).addTo(map);
                            marker.bindPopup(`
                                <b>Booking ID:</b> ${booking.id.substring(0, 8)}<br>
                                <b>Pickup:</b> ${pickupLocation.name || 'N/A'}<br>
                                <b>Fare:</b> UGX ${parseInt(booking.fareAmount).toLocaleString() || 'N/A'}<br>
                                <button class="btn primary-btn btn-sm accept-map-btn mt-2" data-id="${booking.id}">Accept</button>
                            `);
                            markers.set(booking.id, marker);
    
                            marker.on('popupopen', () => {
                                const acceptBtn = marker.getPopup().getElement().querySelector('.accept-map-btn');
                                if (acceptBtn) {
                                    acceptBtn.addEventListener('click', () => acceptBooking(booking.id));
                                }
                            });
                        }
                    });
                }
                if (availableBookingsLoading) availableBookingsLoading.style.display = 'none';
                if (availableBookingsError) availableBookingsError.style.display = 'none';
            }, (error) => {
                console.error("Error fetching available bookings (real-time):", error);
                if (availableBookingsError) {
                    availableBookingsError.textContent = "Error loading available bookings: " + error.message;
                    availableBookingsError.style.display = 'block';
                }
                if (availableBookingsLoading) availableBookingsLoading.style.display = 'none';
            });
        }
        
        function fetchAssignedDeliveries() {
            if (assignedDeliveriesUnsubscribe) {
                assignedDeliveriesUnsubscribe();
            }

            if (assignedDeliveriesLoading) assignedDeliveriesLoading.style.display = 'block';
            if (assignedDeliveriesError) assignedDeliveriesError.style.display = 'none';

            const assignedQ = query(
                collection(db, "bookings"),
                where("assignedDriver", "==", CURRENT_DRIVER_ID),
                where("status", "in", ["Driver Assigned", "In Transit", "Picked Up"])
            );

            assignedDeliveriesUnsubscribe = onSnapshot(assignedQ, (snapshot) => {
                if (assignedDeliveriesList) assignedDeliveriesList.innerHTML = '';
                if (snapshot.empty) {
                    if (noAssignedDeliveriesMessage) noAssignedDeliveriesMessage.style.display = 'block';
                } else {
                    if (noAssignedDeliveriesMessage) noAssignedDeliveriesMessage.style.display = 'none';
                    const bookings = [];
                    snapshot.forEach(doc => {
                        bookings.push({ id: doc.id, ...doc.data() });
                    });

                    bookings.sort((a, b) => {
                        const dateA = a.bookingDate ? a.bookingDate.toDate().getTime() : 0;
                        const dateB = b.bookingDate ? b.bookingDate.toDate().getTime() : 0;
                        return dateB - dateA;
                    });
                    
                    bookings.forEach(booking => {
                        const item = createBookingItem(booking, booking.id, 'assigned');
                        if (assignedDeliveriesList) assignedDeliveriesList.appendChild(item);
                    });
                }
                if (assignedDeliveriesLoading) assignedDeliveriesLoading.style.display = 'none';
                if (assignedDeliveriesError) assignedDeliveriesError.style.display = 'none';
            }, (error) => {
                console.error("Error fetching assigned deliveries (real-time):", error);
                if (assignedDeliveriesError) {
                    assignedDeliveriesError.textContent = "Error loading assigned deliveries: " + error.message;
                    assignedDeliveriesError.style.display = 'block';
                }
                if (assignedDeliveriesLoading) assignedDeliveriesLoading.style.display = 'none';
            });
        }
        
        function fetchCompletedDeliveries() {
            if (completedDeliveriesUnsubscribe) {
                completedDeliveriesUnsubscribe();
            }

            if (completedDeliveriesLoading) completedDeliveriesLoading.style.display = 'block';
            if (completedDeliveriesError) completedDeliveriesError.style.display = 'none';
            
            const completedQ = query(
                collection(db, "bookings"),
                where("assignedDriver", "==", CURRENT_DRIVER_ID),
                where("status", "==", "Completed")
            );

            completedDeliveriesUnsubscribe = onSnapshot(completedQ, (snapshot) => {
                if (completedDeliveriesList) completedDeliveriesList.innerHTML = '';
                let totalEarnings = 0;
                let totalDeliveries = 0;

                if (snapshot.empty) {
                    if (noCompletedDeliveriesMessage) noCompletedDeliveriesMessage.style.display = 'block';
                } else {
                    if (noCompletedDeliveriesMessage) noCompletedDeliveriesMessage.style.display = 'none';
                    const bookings = [];
                    snapshot.forEach(doc => {
                        const bookingData = doc.data();
                        bookings.push({ id: doc.id, ...bookingData });
                        totalEarnings += parseInt(bookingData.fareAmount || 0);
                        totalDeliveries++;
                    });

                    bookings.sort((a, b) => {
                        const dateA = a.completionDate ? a.completionDate.toDate().getTime() : 0;
                        const dateB = b.completionDate ? b.completionDate.toDate().getTime() : 0;
                        return dateB - dateA;
                    });

                    bookings.forEach(booking => {
                        const item = createBookingItem(booking, booking.id, 'completed');
                        if (completedDeliveriesList) completedDeliveriesList.appendChild(item);
                    });
                }
                
                if (totalDeliveriesElement) totalDeliveriesElement.textContent = totalDeliveries.toLocaleString();
                if (totalEarningsElement) totalEarningsElement.textContent = `UGX ${totalEarnings.toLocaleString()}`;

                if (completedDeliveriesLoading) completedDeliveriesLoading.style.display = 'none';
                if (completedDeliveriesError) completedDeliveriesError.style.display = 'none';

            }, (error) => {
                console.error("Error fetching completed deliveries (real-time):", error);
                if (completedDeliveriesError) {
                    completedDeliveriesError.textContent = "Error loading completed deliveries: " + error.message;
                    completedDeliveriesError.style.display = 'block';
                }
                if (completedDeliveriesLoading) completedDeliveriesLoading.style.display = 'none';
            });
        }


        // --- Accept Booking Function ---
        async function acceptBooking(bookingId) {
            const acceptBtn = document.querySelector(`.accept-booking-btn[data-id="${bookingId}"]`) || document.querySelector(`.accept-map-btn[data-id="${bookingId}"]`);
            if (!acceptBtn) return;

            acceptBtn.disabled = true;
            const originalText = acceptBtn.innerHTML;
            acceptBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accepting...';

            try {
                const bookingRef = doc(db, "bookings", bookingId);
                await updateDoc(bookingRef, {
                    status: "Driver Assigned",
                    assignedDriver: CURRENT_DRIVER_ID,
                    assignmentDate: serverTimestamp(),
                });
            } catch (error) {
                console.error("Error accepting booking:", error);
                showModal("Failed to accept booking. Please try again.");
                acceptBtn.disabled = false;
                acceptBtn.innerHTML = originalText;
            }
        }

        // --- Decline Booking Function ---
        async function declineBooking(bookingId) {
            const declineBtn = document.querySelector(`.decline-booking-btn[data-id="${bookingId}"]`);
            if (!declineBtn) return;

            declineBtn.disabled = true;
            const originalText = declineBtn.innerHTML;
            declineBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Declining...';

            try {
                const bookingRef = doc(db, "bookings", bookingId);
                await updateDoc(bookingRef, {
                    declinedByDrivers: arrayUnion(CURRENT_DRIVER_ID)
                });
            } catch (error) {
                console.error("Error declining booking:", error);
                showModal("Failed to decline booking. Please try again.");
                declineBtn.disabled = false;
                declineBtn.innerHTML = originalText;
            }
        }
        
        // --- Update Booking Status Function ---
        async function updateBookingStatus(bookingId, newStatus, itemElement) {
            const updateBtn = itemElement.querySelector(`.status-update-btn[data-id="${bookingId}"][data-status="${newStatus}"]`);
            if (!updateBtn) return;
            
            if (newStatus === 'Completed' && updateBtn.dataset.podCaptured !== 'true') {
                return showModal("Please capture proof of delivery before marking as completed.");
            }

            const originalText = updateBtn.innerHTML;
            updateBtn.disabled = true;
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';

            try {
                const bookingRef = doc(db, "bookings", bookingId);
                const updateData = { status: newStatus };

                if (newStatus === 'Completed') {
                    updateData.completionDate = serverTimestamp();
                }

                await updateDoc(bookingRef, updateData);
                
                updateBtn.disabled = false;
                updateBtn.innerHTML = originalText;
                
            } catch (error) {
                console.error("Error updating booking status:", error);
                showModal(`Failed to update status to ${newStatus}: ${error.message}`);
                updateBtn.disabled = false;
                updateBtn.innerHTML = originalText;
            }
        }
        
        // --- Call Contact Function ---
        function callContact(phoneNumber) {
            if (phoneNumber) {
                window.location.href = `tel:${phoneNumber}`;
            } else {
                showModal("Phone number is not available for this booking.");
            }
        }

        // --- Authentication State Listener ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                CURRENT_DRIVER_ID = user.uid;
                
                // Show loading spinner for all sections
                if(availableBookingsLoading) availableBookingsLoading.style.display = 'block';
                if(assignedDeliveriesLoading) assignedDeliveriesLoading.style.display = 'block';
                if(completedDeliveriesLoading) completedDeliveriesLoading.style.display = 'block';
                
                // Set up a real-time listener for the driver's profile
                const driverProfileRef = doc(db, "users", user.uid);
                driverProfileUnsubscribe = onSnapshot(driverProfileRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().isDriver) {
                        const userData = docSnap.data();
                        const fullName = userData.name || "Driver";
                        const firstName = fullName.split(' ')[0] || "Driver";
                        
                        if (userNameDisplay) userNameDisplay.textContent = firstName;
                        
                        // Update UI based on availability
                        const isAvailable = userData.isAvailable || false;
                        updateAvailabilityUI(isAvailable);

                        // If the user is authenticated and on duty, start tracking.
                        // We also call it here to handle page reloads while on duty.
                        if (isAvailable) {
                            startLocationTracking();
                        } else {
                            stopLocationTracking();
                        }
                        
                        // Enable the availability toggle button once data is loaded
                        if (availabilityToggleBtn) {
                            availabilityToggleBtn.disabled = false;
                        }

                        // Fetch other data
                        fetchAssignedDeliveries();
                        fetchCompletedDeliveries();
                        
                    } else {
                        // User is not a driver or profile does not exist
                        console.error("Access Denied: Not an authorized driver or user profile missing.");
                        showModal("Access Denied: Your driver profile could not be found. You will be logged out.");
                        // Display a more permanent error on the page
                        if (userNameDisplay) userNameDisplay.textContent = 'Error';
                        if (availabilityToggleBtn) {
                             availabilityToggleBtn.disabled = true;
                             availabilityToggleBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                             availabilityToggleBtn.classList.remove('primary-btn');
                             availabilityToggleBtn.classList.add('danger-btn');
                        }
                        
                        // Clear all content sections
                        if(availableBookingsList) availableBookingsList.innerHTML = '';
                        if(assignedDeliveriesList) assignedDeliveriesList.innerHTML = '';
                        if(completedDeliveriesList) completedDeliveriesList.innerHTML = '';

                        stopLocationTracking();
                        setTimeout(() => signOut(auth).then(() => window.location.href = 'login.html'), 5000);
                    }
                }, (error) => {
                    console.error("Error fetching user data in real-time:", error);
                    showModal("Error loading user profile. Please check your network connection and try again.");
                    
                    // Display a more permanent error on the page
                    if (userNameDisplay) userNameDisplay.textContent = 'Error';
                    if (availabilityToggleBtn) {
                         availabilityToggleBtn.disabled = true;
                         availabilityToggleBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                         availabilityToggleBtn.classList.remove('primary-btn');
                         availabilityToggleBtn.classList.add('danger-btn');
                    }
                    
                    // Display an error in all content sections
                    if(availableBookingsError) { availableBookingsError.textContent = "Error loading user data."; availableBookingsError.style.display = 'block'; }
                    if(assignedDeliveriesError) { assignedDeliveriesError.textContent = "Error loading user data."; assignedDeliveriesError.style.display = 'block'; }
                    if(completedDeliveriesError) { completedDeliveriesError.textContent = "Error loading user data."; completedDeliveriesError.style.display = 'block'; }
                    if(availableBookingsLoading) availableBookingsLoading.style.display = 'none';
                    if(assignedDeliveriesLoading) assignedDeliveriesLoading.style.display = 'none';
                    if(completedDeliveriesLoading) completedDeliveriesLoading.style.display = 'none';
                    
                    stopLocationTracking();
                });

            } else {
                // User is not logged in
                if (driverProfileUnsubscribe) driverProfileUnsubscribe();
                if (availableBookingsUnsubscribe) availableBookingsUnsubscribe();
                if (assignedDeliveriesUnsubscribe) assignedDeliveriesUnsubscribe();
                if (completedDeliveriesUnsubscribe) completedDeliveriesUnsubscribe();
                stopLocationTracking();

                showModal("You must be logged in to view this page. Redirecting to home...");
                setTimeout(() => window.location.href = 'login.html', 3000);
            }
        });

        if (availabilityToggleBtn) {
            availabilityToggleBtn.addEventListener('click', toggleAvailability);
        }

    </script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20n6c9lI/R96C17D/a8uG6fFp6I8w/C4S4t3a9ZlQ04=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
</body>
</html>
